{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/rahan/Magang/cicd/Naratel-Devops-Dashboard/src/app/api/k8s/secret/route.js"],"sourcesContent":["// app/api/k8s/secret/route.js\nprocess.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';\n\nimport { NextResponse } from 'next/server';\n\nexport async function POST(request) {\n  try {\n    const { secretName, namespace, data, secretType } = await request.json();\n    \n    // Validasi input\n    if (!secretName || !namespace || !data || Object.keys(data).length === 0) {\n      return NextResponse.json({ \n        success: false,\n        message: 'Secret name, namespace, dan data diperlukan' \n      }, { status: 400 });\n    }\n\n    // Get Kubernetes config from env\n    const { K8S_API_URL, K8S_TOKEN, K8S_NAMESPACE } = process.env;\n    \n    if (!K8S_API_URL || !K8S_TOKEN) {\n      return NextResponse.json({ \n        success: false,\n        message: 'Kubernetes config tidak ditemukan di environment' \n      }, { status: 500 });\n    }\n\n    // Encode data to base64 (Kubernetes requirement)\n    const encodedData = {};\n    for (const [key, value] of Object.entries(data)) {\n      encodedData[key] = Buffer.from(value).toString('base64');\n    }\n\n    // Prepare secret payload\n    const secretPayload = {\n      apiVersion: 'v1',\n      kind: 'Secret',\n      metadata: {\n        name: secretName,\n        namespace: namespace || K8S_NAMESPACE || 'default'\n      },\n      type: secretType || 'Opaque',\n      data: encodedData\n    };\n\n    const headers = {\n      'Authorization': `Bearer ${K8S_TOKEN}`,\n      'Content-Type': 'application/json',\n      'Accept': 'application/json'\n    };\n\n    // Try to create secret\n    const createUrl = `${K8S_API_URL}/api/v1/namespaces/${secretPayload.metadata.namespace}/secrets`;\n    \n    console.log(`ðŸ” Creating secret: ${secretName} in namespace: ${secretPayload.metadata.namespace}`);\n    \n    const createRes = await fetch(createUrl, {\n      method: 'POST',\n      headers,\n      body: JSON.stringify(secretPayload)\n    });\n\n    if (createRes.ok) {\n      const result = await createRes.json();\n      return NextResponse.json({ \n        success: true,\n        message: `Secret \"${secretName}\" berhasil dibuat di namespace \"${secretPayload.metadata.namespace}\"`,\n        data: result\n      });\n    } \n    \n    // If creation fails with 409 (already exists), try to update\n    if (createRes.status === 409) {\n      console.log(`ðŸ”„ Secret sudah ada, mencoba update...`);\n      \n      const updateUrl = `${K8S_API_URL}/api/v1/namespaces/${secretPayload.metadata.namespace}/secrets/${secretName}`;\n      \n      const updateRes = await fetch(updateUrl, {\n        method: 'PUT',\n        headers,\n        body: JSON.stringify(secretPayload)\n      });\n\n      if (updateRes.ok) {\n        const result = await updateRes.json();\n        return NextResponse.json({ \n          success: true,\n          message: `Secret \"${secretName}\" berhasil diupdate di namespace \"${secretPayload.metadata.namespace}\"`,\n          data: result\n        });\n      } else {\n        const errorText = await updateRes.text();\n        throw new Error(`Update failed: ${errorText}`);\n      }\n    }\n\n    // Handle other errors\n    const errorText = await createRes.text();\n    throw new Error(`Kubernetes API error: ${errorText}`);\n\n  } catch (error) {\n    console.error('âŒ Error creating/updating secret:', error.message);\n    return NextResponse.json({ \n      success: false,\n      error: error.message \n    }, { status: 500 });\n  }\n}\n\n// GET endpoint untuk list secrets (optional)\nexport async function GET(request) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const namespace = searchParams.get('namespace') || process.env.K8S_NAMESPACE || 'default';\n\n    const { K8S_API_URL, K8S_TOKEN } = process.env;\n    \n    if (!K8S_API_URL || !K8S_TOKEN) {\n      return NextResponse.json({ \n        success: false,\n        message: 'Kubernetes config tidak ditemukan' \n      }, { status: 500 });\n    }\n\n    const headers = {\n      'Authorization': `Bearer ${K8S_TOKEN}`,\n      'Accept': 'application/json'\n    };\n\n    const url = `${K8S_API_URL}/api/v1/namespaces/${namespace}/secrets`;\n    const res = await fetch(url, { headers });\n\n    if (!res.ok) {\n      throw new Error(`Failed to fetch secrets: ${res.statusText}`);\n    }\n\n    const data = await res.json();\n    \n    // Filter dan format data\n    const secrets = data.items.map(secret => ({\n      name: secret.metadata.name,\n      namespace: secret.metadata.namespace,\n      type: secret.type,\n      createdAt: secret.metadata.creationTimestamp,\n      dataKeys: Object.keys(secret.data || {})\n    }));\n\n    return NextResponse.json({ \n      success: true,\n      secrets,\n      namespace \n    });\n\n  } catch (error) {\n    console.error('Error fetching secrets:', error.message);\n    return NextResponse.json({ \n      success: false,\n      error: error.message \n    }, { status: 500 });\n  }\n}"],"names":[],"mappings":"AAAA,8BAA8B;;;;;;;AAG9B;AAFA,QAAQ,GAAG,CAAC,4BAA4B,GAAG;;AAIpC,eAAe,KAAK,OAAO;IAChC,IAAI;QACF,MAAM,EAAE,UAAU,EAAE,SAAS,EAAE,IAAI,EAAE,UAAU,EAAE,GAAG,MAAM,QAAQ,IAAI;QAEtE,iBAAiB;QACjB,IAAI,CAAC,cAAc,CAAC,aAAa,CAAC,QAAQ,OAAO,IAAI,CAAC,MAAM,MAAM,KAAK,GAAG;YACxE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,SAAS;YACX,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,iCAAiC;QACjC,MAAM,EAAE,WAAW,EAAE,SAAS,EAAE,aAAa,EAAE,GAAG,QAAQ,GAAG;QAE7D,IAAI,CAAC,eAAe,CAAC,WAAW;YAC9B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,SAAS;YACX,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,iDAAiD;QACjD,MAAM,cAAc,CAAC;QACrB,KAAK,MAAM,CAAC,KAAK,MAAM,IAAI,OAAO,OAAO,CAAC,MAAO;YAC/C,WAAW,CAAC,IAAI,GAAG,OAAO,IAAI,CAAC,OAAO,QAAQ,CAAC;QACjD;QAEA,yBAAyB;QACzB,MAAM,gBAAgB;YACpB,YAAY;YACZ,MAAM;YACN,UAAU;gBACR,MAAM;gBACN,WAAW,aAAa,iBAAiB;YAC3C;YACA,MAAM,cAAc;YACpB,MAAM;QACR;QAEA,MAAM,UAAU;YACd,iBAAiB,CAAC,OAAO,EAAE,WAAW;YACtC,gBAAgB;YAChB,UAAU;QACZ;QAEA,uBAAuB;QACvB,MAAM,YAAY,GAAG,YAAY,mBAAmB,EAAE,cAAc,QAAQ,CAAC,SAAS,CAAC,QAAQ,CAAC;QAEhG,QAAQ,GAAG,CAAC,CAAC,oBAAoB,EAAE,WAAW,eAAe,EAAE,cAAc,QAAQ,CAAC,SAAS,EAAE;QAEjG,MAAM,YAAY,MAAM,MAAM,WAAW;YACvC,QAAQ;YACR;YACA,MAAM,KAAK,SAAS,CAAC;QACvB;QAEA,IAAI,UAAU,EAAE,EAAE;YAChB,MAAM,SAAS,MAAM,UAAU,IAAI;YACnC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,SAAS,CAAC,QAAQ,EAAE,WAAW,gCAAgC,EAAE,cAAc,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC;gBACpG,MAAM;YACR;QACF;QAEA,6DAA6D;QAC7D,IAAI,UAAU,MAAM,KAAK,KAAK;YAC5B,QAAQ,GAAG,CAAC,CAAC,sCAAsC,CAAC;YAEpD,MAAM,YAAY,GAAG,YAAY,mBAAmB,EAAE,cAAc,QAAQ,CAAC,SAAS,CAAC,SAAS,EAAE,YAAY;YAE9G,MAAM,YAAY,MAAM,MAAM,WAAW;gBACvC,QAAQ;gBACR;gBACA,MAAM,KAAK,SAAS,CAAC;YACvB;YAEA,IAAI,UAAU,EAAE,EAAE;gBAChB,MAAM,SAAS,MAAM,UAAU,IAAI;gBACnC,OAAO,gJAAY,CAAC,IAAI,CAAC;oBACvB,SAAS;oBACT,SAAS,CAAC,QAAQ,EAAE,WAAW,kCAAkC,EAAE,cAAc,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC;oBACtG,MAAM;gBACR;YACF,OAAO;gBACL,MAAM,YAAY,MAAM,UAAU,IAAI;gBACtC,MAAM,IAAI,MAAM,CAAC,eAAe,EAAE,WAAW;YAC/C;QACF;QAEA,sBAAsB;QACtB,MAAM,YAAY,MAAM,UAAU,IAAI;QACtC,MAAM,IAAI,MAAM,CAAC,sBAAsB,EAAE,WAAW;IAEtD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC,MAAM,OAAO;QAChE,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO,MAAM,OAAO;QACtB,GAAG;YAAE,QAAQ;QAAI;IACnB;AACF;AAGO,eAAe,IAAI,OAAO;IAC/B,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,YAAY,aAAa,GAAG,CAAC,gBAAgB,QAAQ,GAAG,CAAC,aAAa,IAAI;QAEhF,MAAM,EAAE,WAAW,EAAE,SAAS,EAAE,GAAG,QAAQ,GAAG;QAE9C,IAAI,CAAC,eAAe,CAAC,WAAW;YAC9B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,SAAS;YACX,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,MAAM,UAAU;YACd,iBAAiB,CAAC,OAAO,EAAE,WAAW;YACtC,UAAU;QACZ;QAEA,MAAM,MAAM,GAAG,YAAY,mBAAmB,EAAE,UAAU,QAAQ,CAAC;QACnE,MAAM,MAAM,MAAM,MAAM,KAAK;YAAE;QAAQ;QAEvC,IAAI,CAAC,IAAI,EAAE,EAAE;YACX,MAAM,IAAI,MAAM,CAAC,yBAAyB,EAAE,IAAI,UAAU,EAAE;QAC9D;QAEA,MAAM,OAAO,MAAM,IAAI,IAAI;QAE3B,yBAAyB;QACzB,MAAM,UAAU,KAAK,KAAK,CAAC,GAAG,CAAC,CAAA,SAAU,CAAC;gBACxC,MAAM,OAAO,QAAQ,CAAC,IAAI;gBAC1B,WAAW,OAAO,QAAQ,CAAC,SAAS;gBACpC,MAAM,OAAO,IAAI;gBACjB,WAAW,OAAO,QAAQ,CAAC,iBAAiB;gBAC5C,UAAU,OAAO,IAAI,CAAC,OAAO,IAAI,IAAI,CAAC;YACxC,CAAC;QAED,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT;YACA;QACF;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B,MAAM,OAAO;QACtD,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO,MAAM,OAAO;QACtB,GAAG;YAAE,QAAQ;QAAI;IACnB;AACF"}}]
}