{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/fix/Naratel-Devops-Dashboard/src/lib/gitMutex.js"],"sourcesContent":["import { Mutex } from 'async-mutex';\n\n// Shared mutex instance to prevent race conditions during Git operations\nexport const gitMutex = new Mutex();\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,WAAW,IAAI,4LAAK"}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/fix/Naratel-Devops-Dashboard/src/app/api/manifest/ingress/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { execSync } from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\nimport os from 'os';\nimport yaml from 'js-yaml';\nimport { gitMutex } from '@/lib/gitMutex';\n\nexport const dynamic = 'force-dynamic';\n\nconst getRepoConfig = () => {\n    return {\n        repoPath: path.join(os.tmpdir(), 'manifest-repo-workdir'),\n        token: process.env.GITHUB_TOKEN,\n        repoUrl: process.env.MANIFEST_REPO_URL,\n        userName: process.env.GIT_USER_NAME || \"Naratel DevOps Dashboard\",\n        userEmail: process.env.GIT_USER_EMAIL || \"devops@naratel.com\"\n    };\n};\n\nconst readIngressConfig = (filePath) => {\n    if (!fs.existsSync(filePath)) return null;\n    try {\n        const content = fs.readFileSync(filePath, 'utf8');\n        const parsed = yaml.load(content);\n        \n        const ing = parsed.ingress || {};\n        const host = ing.hosts && ing.hosts[0] ? ing.hosts[0].host : \"\";\n        \n        return {\n            enabled: ing.enabled || false,\n            host: host,\n            tls: !!(ing.tls && ing.tls.length > 0)\n        };\n    } catch (e) {\n        console.error(`Failed to read ${filePath}:`, e.message);\n        return null;\n    }\n};\n\nconst updateIngressConfig = (filePath, config, isTesting, appName) => {\n    if (!fs.existsSync(filePath)) return;\n\n    try {\n        const content = fs.readFileSync(filePath, 'utf8');\n        const doc = yaml.load(content);\n\n        if (!config.enabled) {\n            doc.ingress = { enabled: false };\n        } else {\n            const targetHost = isTesting ? `test-${config.host}` : config.host;\n            doc.ingress = {\n                enabled: true,\n                className: \"nginx\",\n                hosts: [ { host: targetHost, path: \"/\" } ]\n            };\n            if (config.tls) {\n                doc.ingress.tls = [ { secretName: `${appName}-tls`, hosts: [targetHost] } ];\n            } else {\n                delete doc.ingress.tls;\n            }\n        }\n\n        const newYaml = yaml.dump(doc, { lineWidth: -1 });\n        fs.writeFileSync(filePath, newYaml);\n    } catch (e) {\n        throw new Error(`Failed to update ${path.basename(filePath)}: ${e.message}`);\n    }\n};\n\nexport async function GET(req) {\n    const { searchParams } = new URL(req.url);\n    const appName = searchParams.get('appName');\n    if (!appName) return NextResponse.json({ error: \"App Name required\" }, { status: 400 });\n\n    return await gitMutex.runExclusive(async () => {\n        const { repoPath, repoUrl, token, userName, userEmail } = getRepoConfig();\n        const authenticatedUrl = repoUrl.replace(\"https://\", `https://${token}@`);\n\n        try {\n            if (!fs.existsSync(repoPath)) {\n                execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n            } else {\n                try {\n                    execSync(`git fetch origin`, { cwd: repoPath });\n                    execSync(`git reset --hard origin/main`, { cwd: repoPath });\n                } catch (e) {\n                    fs.rmSync(repoPath, { recursive: true, force: true });\n                    execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n                }\n            }\n            execSync(`git config user.name \"${userName}\"`, { cwd: repoPath });\n            execSync(`git config user.email \"${userEmail}\"`, { cwd: repoPath });\n\n            const registryPath = path.join(repoPath, 'registry.json');\n            let appId = null;\n            if (fs.existsSync(registryPath)) {\n                try {\n                    const registry = JSON.parse(fs.readFileSync(registryPath, 'utf8'));\n                    const appEntry = registry.find(a => a.name === appName);\n                    if (appEntry) appId = appEntry.id;\n                } catch (e) { console.error(\"Failed to parse registry\", e); }\n            }\n\n            let prodPath = path.join(repoPath, 'apps', `${appId}-${appName}-prod`, 'values.yaml');\n            if (!fs.existsSync(prodPath)) {\n                const legacyPath = path.join(repoPath, 'apps', `${appName}-prod`, 'values.yaml');\n                if (fs.existsSync(legacyPath)) prodPath = legacyPath;\n            }\n            \n            const config = readIngressConfig(prodPath);\n            return NextResponse.json(config || { enabled: false, host: \"\", tls: false });\n\n        } catch (err) {\n            console.error(err);\n            return NextResponse.json({ error: err.message }, { status: 500 });\n        }\n    });\n}\n\nexport async function POST(req) {\n    const { appName, enabled, host, tls } = await req.json();\n    if (!appName) return NextResponse.json({ error: \"Missing App Name\" }, { status: 400 });\n\n    return await gitMutex.runExclusive(async () => {\n        const { repoPath, repoUrl, token, userName, userEmail } = getRepoConfig();\n        const authenticatedUrl = repoUrl.replace(\"https://\", `https://${token}@`);\n\n        try {\n            if (!fs.existsSync(repoPath)) {\n                execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n            } else {\n                 try {\n                    execSync(`git fetch origin`, { cwd: repoPath });\n                    execSync(`git reset --hard origin/main`, { cwd: repoPath });\n                } catch (e) {\n                    fs.rmSync(repoPath, { recursive: true, force: true });\n                    execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n                }\n            }\n            execSync(`git config user.name \"${userName}\"`, { cwd: repoPath });\n            execSync(`git config user.email \"${userEmail}\"`, { cwd: repoPath });\n\n            const regPath = path.join(repoPath, 'registry.json');\n            let appId = null;\n            if (fs.existsSync(regPath)) {\n                try {\n                    const registry = JSON.parse(fs.readFileSync(regPath, 'utf8'));\n                    const appEntry = registry.find(a => a.name === appName);\n                    if (appEntry) appId = appEntry.id;\n                } catch (e) { console.error(\"Failed to parse registry\", e); }\n            }\n\n            let prodPath = path.join(repoPath, 'apps', `${appId}-${appName}-prod`, 'values.yaml');\n            if (!fs.existsSync(prodPath)) {\n                const legacyPath = path.join(repoPath, 'apps', `${appName}-prod`, 'values.yaml');\n                if (fs.existsSync(legacyPath)) prodPath = legacyPath;\n            }\n\n            const config = { enabled, host, tls };\n            updateIngressConfig(prodPath, config, false, appName);\n\n            // Update Registry to sync ingressHost\n            if (fs.existsSync(regPath)) {\n                try {\n                    let registry = JSON.parse(fs.readFileSync(regPath, 'utf8'));\n                    const idx = registry.findIndex(r => r.name === appName);\n                    if (idx >= 0) {\n                        registry[idx].ingressHost = enabled ? host : null;\n                        fs.writeFileSync(regPath, JSON.stringify(registry, null, 2));\n                    }\n                } catch (regErr) {\n                    console.error(\"Registry sync failed:\", regErr.message);\n                }\n            }\n\n            execSync(`git add .`, { cwd: repoPath });\n            const status = execSync(`git status --porcelain`, { cwd: repoPath }).toString();\n            \n            if (status.trim()) {\n                execSync(`git commit -m \"chore: update ingress config for ${appName}\"`, { cwd: repoPath });\n                execSync(`git push origin main`, { cwd: repoPath });\n                return NextResponse.json({ message: \"Ingress configuration updated!\" });\n            } else {\n                return NextResponse.json({ message: \"No changes detected.\" });\n            }\n\n        } catch (err) {\n            console.error(err);\n            return NextResponse.json({ error: err.message }, { status: 500 });\n        }\n    });\n}"],"names":[],"mappings":"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"}}]
}