{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/fix/Naratel-Devops-Dashboard/src/app/api/jenkins/approve/route.js"],"sourcesContent":["// app/api/jenkins/approve/route.js\n\nimport { NextResponse } from 'next/server';\n\nexport async function POST(request) {\n  // Terima buildId, jobName, dan action (approve/abort)\n  const { buildId, jobName, action } = await request.json();\n  const { JENKINS_URL, JENKINS_USER, JENKINS_API_TOKEN } = process.env;\n  const auth = Buffer.from(`${JENKINS_USER}:${JENKINS_API_TOKEN}`).toString('base64');\n  const headers = { 'Authorization': `Basic ${auth}` };\n\n  if (!buildId || !jobName || !action) {\n    return NextResponse.json({ \n      message: 'Build ID, Job Name, and Action required' \n    }, { status: 400 });\n  }\n\n  try {\n    console.log(`üîç Mencari Input ID untuk Job: ${jobName} | Build: #${buildId} | Action: ${action}...`);\n    \n    // 1. Cari ID Input Dinamis berdasarkan Job Name spesifik\n    const checkRes = await fetch(\n      `${JENKINS_URL}/job/${jobName}/${buildId}/wfapi/pendingInputActions`,\n      { headers, cache: 'no-store' }\n    );\n\n    if (!checkRes.ok) throw new Error(\"Gagal mengambil info Jenkins\");\n\n    const actions = await checkRes.json();\n    if (!actions || actions.length === 0) {\n      return NextResponse.json({ \n        message: 'Build ini sudah tidak menunggu approval.' \n      }, { status: 400 });\n    }\n\n    const inputId = actions[0].id; \n    console.log(`‚úÖ Input ID Ditemukan: ${inputId}`);\n\n    // 2. Tentukan URL berdasarkan action (approve atau abort)\n    let actionUrl;\n    let actionMessage;\n\n    if (action === 'approve') {\n      actionUrl = `${JENKINS_URL}/job/${jobName}/${buildId}/input/${inputId}/proceedEmpty`;\n      actionMessage = 'Approved';\n    } else if (action === 'abort') {\n      actionUrl = `${JENKINS_URL}/job/${jobName}/${buildId}/input/${inputId}/abort`;\n      actionMessage = 'Aborted';\n    } else {\n      return NextResponse.json({ \n        message: 'Invalid action. Use \"approve\" or \"abort\".' \n      }, { status: 400 });\n    }\n\n    // 3. Kirim request ke Jenkins\n    const actionRes = await fetch(actionUrl, { \n      method: 'POST', \n      headers \n    });\n\n    if (actionRes.ok) {\n      return NextResponse.json({ \n        success: true, \n        message: `Pipeline ${jobName} #${buildId} ${actionMessage}!` \n      });\n    } else {\n      throw new Error(await actionRes.text());\n    }\n  } catch (error) {\n    console.error(\"Server Error:\", error.message);\n    return NextResponse.json({ \n      success: false, \n      error: error.message \n    }, { status: 500 });\n  }\n}"],"names":[],"mappings":"AAAA,mCAAmC;;;;;AAEnC;;AAEO,eAAe,KAAK,OAAO;IAChC,sDAAsD;IACtD,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,MAAM,EAAE,GAAG,MAAM,QAAQ,IAAI;IACvD,MAAM,EAAE,WAAW,EAAE,YAAY,EAAE,iBAAiB,EAAE,GAAG,QAAQ,GAAG;IACpE,MAAM,OAAO,OAAO,IAAI,CAAC,GAAG,aAAa,CAAC,EAAE,mBAAmB,EAAE,QAAQ,CAAC;IAC1E,MAAM,UAAU;QAAE,iBAAiB,CAAC,MAAM,EAAE,MAAM;IAAC;IAEnD,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,QAAQ;QACnC,OAAO,yLAAY,CAAC,IAAI,CAAC;YACvB,SAAS;QACX,GAAG;YAAE,QAAQ;QAAI;IACnB;IAEA,IAAI;QACF,QAAQ,GAAG,CAAC,CAAC,+BAA+B,EAAE,QAAQ,WAAW,EAAE,QAAQ,WAAW,EAAE,OAAO,GAAG,CAAC;QAEnG,yDAAyD;QACzD,MAAM,WAAW,MAAM,MACrB,GAAG,YAAY,KAAK,EAAE,QAAQ,CAAC,EAAE,QAAQ,0BAA0B,CAAC,EACpE;YAAE;YAAS,OAAO;QAAW;QAG/B,IAAI,CAAC,SAAS,EAAE,EAAE,MAAM,IAAI,MAAM;QAElC,MAAM,UAAU,MAAM,SAAS,IAAI;QACnC,IAAI,CAAC,WAAW,QAAQ,MAAM,KAAK,GAAG;YACpC,OAAO,yLAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;YACX,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,MAAM,UAAU,OAAO,CAAC,EAAE,CAAC,EAAE;QAC7B,QAAQ,GAAG,CAAC,CAAC,sBAAsB,EAAE,SAAS;QAE9C,0DAA0D;QAC1D,IAAI;QACJ,IAAI;QAEJ,IAAI,WAAW,WAAW;YACxB,YAAY,GAAG,YAAY,KAAK,EAAE,QAAQ,CAAC,EAAE,QAAQ,OAAO,EAAE,QAAQ,aAAa,CAAC;YACpF,gBAAgB;QAClB,OAAO,IAAI,WAAW,SAAS;YAC7B,YAAY,GAAG,YAAY,KAAK,EAAE,QAAQ,CAAC,EAAE,QAAQ,OAAO,EAAE,QAAQ,MAAM,CAAC;YAC7E,gBAAgB;QAClB,OAAO;YACL,OAAO,yLAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;YACX,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,8BAA8B;QAC9B,MAAM,YAAY,MAAM,MAAM,WAAW;YACvC,QAAQ;YACR;QACF;QAEA,IAAI,UAAU,EAAE,EAAE;YAChB,OAAO,yLAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,SAAS,CAAC,SAAS,EAAE,QAAQ,EAAE,EAAE,QAAQ,CAAC,EAAE,cAAc,CAAC,CAAC;YAC9D;QACF,OAAO;YACL,MAAM,IAAI,MAAM,MAAM,UAAU,IAAI;QACtC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iBAAiB,MAAM,OAAO;QAC5C,OAAO,yLAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO,MAAM,OAAO;QACtB,GAAG;YAAE,QAAQ;QAAI;IACnB;AACF"}}]
}