{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/webui-devops/Naratel-Devops-Dashboard/src/app/api/jenkins/pending/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\n\nexport async function GET() {\n  const { JENKINS_URL, JENKINS_USER, JENKINS_API_TOKEN } = process.env;\n\n  if (!JENKINS_URL || !JENKINS_USER || !JENKINS_API_TOKEN) {\n    return NextResponse.json(\n      { error: 'Konfigurasi Jenkins tidak lengkap di ENV' },\n      { status: 500 }\n    );\n  }\n\n  const auth = Buffer.from(`${JENKINS_USER}:${JENKINS_API_TOKEN}`).toString('base64');\n\n  try {\n    // 1. Fetch daftar semua jobs dari Jenkins (Optimized dengan tree)\n    // Kita hanya mengambil job yang sedang building/running untuk mengurangi request ke API\n    const jobsResponse = await fetch(`${JENKINS_URL}/api/json?tree=jobs[name,url,color,lastBuild[building]]`, {\n      headers: { 'Authorization': `Basic ${auth}` },\n      cache: 'no-store'\n    });\n\n    if (!jobsResponse.ok) {\n      throw new Error(`Gagal fetch daftar jobs: ${jobsResponse.statusText}`);\n    }\n\n    const jenkinsData = await jobsResponse.json();\n    const allJobs = jenkinsData.jobs || [];\n\n    if (allJobs.length === 0) {\n      return NextResponse.json({ message: 'Tidak ada job ditemukan di Jenkins' });\n    }\n\n    // 2. Filter hanya job yang sedang aktif (Running/Building)\n    const activeJobs = allJobs.filter(job => {\n      // Cek apakah lastBuild sedang building atau color punya animasi (indikator running)\n      const isBuilding = job.lastBuild?.building === true;\n      const isAnime = job.color?.toString().endsWith('_anime');\n      return isBuilding || isAnime;\n    });\n\n    // Extract nama job dari active jobs\n    const jobNames = activeJobs.map(job => job.name);\n\n    console.log(`Optimization: Processing ${jobNames.length} active jobs out of ${allJobs.length} total jobs.`);\n    \n    if (jobNames.length === 0) {\n      return NextResponse.json({\n        totalJobs: allJobs.length,\n        activeJobs: 0,\n        pendingBuilds: 0,\n        data: []\n      });\n    }\n\n    // 3. Fetch data dari ACTIVE job secara Paralel (Promise.all)\n    const promises = jobNames.map(async (jobName) => {\n      try {\n        const res = await fetch(`${JENKINS_URL}/job/${jobName}/wfapi/runs`, {\n          headers: { 'Authorization': `Basic ${auth}` },\n          cache: 'no-store'\n        });\n\n        if (!res.ok) {\n          console.log(`Job ${jobName}: HTTP ${res.status}`);\n          return [];\n        }\n\n        const runs = await res.json();\n        console.log(`Job ${jobName}: ${runs.length} runs ditemukan`);\n\n        // Filter pending runs\n        const pendingRuns = runs.filter(run => {\n            console.log(`  - Run ${run.id}: status = ${run.status}`);\n            return run.status === 'PAUSED_PENDING_INPUT';\n        });\n\n        if (pendingRuns.length > 0) {\n          console.log(`Job ${jobName}: ${pendingRuns.length} pending approval ditemukan!`);\n        }\n\n        // Map & Fetch Details (Parameters) secara paralel\n        const pending = await Promise.all(pendingRuns.map(async (run) => {\n            let tag = null;\n            try {\n                const detailsRes = await fetch(`${JENKINS_URL}/job/${jobName}/${run.id}/api/json?tree=actions[parameters[name,value]]`, {\n                    headers: { 'Authorization': `Basic ${auth}` },\n                    cache: 'no-store'\n                });\n\n                if (detailsRes.ok) {\n                    const details = await detailsRes.json();\n                    \n                    // Collect all parameters from all actions\n                    let allParams = [];\n                    const actions = details.actions || [];\n                    \n                    actions.forEach(action => {\n                        if (action.parameters && Array.isArray(action.parameters)) {\n                            allParams = [...allParams, ...action.parameters];\n                        }\n                    });\n\n                    console.log(`[DEBUG] Job ${jobName} #${run.id} Params:`, JSON.stringify(allParams.map(p => `${p.name}=${p.value}`)));\n                    \n                    // Case-insensitive search for Tag/Version\n                    const tagParam = allParams.find(p => {\n                        const name = p.name.toUpperCase();\n                        return ['TAG', 'IMAGE_TAG', 'VERSION', 'DOCKER_TAG', 'RELEASE_TAG', 'BUILD_TAG'].includes(name);\n                    });\n\n                    if (tagParam) {\n                        tag = tagParam.value;\n                        console.log(`[DEBUG] Found Tag: ${tag}`);\n                    }\n                }\n            } catch (e) {\n                console.warn(`Gagal fetch parameters untuk ${jobName} #${run.id}:`, e.message);\n            }\n\n            return {\n                id: run.id,\n                name: run.name,\n                status: run.status,\n                timestamp: run.startTimeMillis,\n                jobName: jobName,\n                tag: tag\n            };\n        }));\n\n        return pending;\n      } catch (err) {\n        console.error(`Gagal fetch job ${jobName}:`, err.message);\n        return [];\n      }\n    });\n\n    // Tunggu semua request selesai\n    const results = await Promise.all(promises);\n\n    // 4. Gabungkan array of arrays menjadi satu array flat (single list)\n    const allPendingBuilds = results.flat();\n\n    // Urutkan berdasarkan waktu (terbaru diatas)\n    allPendingBuilds.sort((a, b) => b.timestamp - a.timestamp);\n\n    console.log('Total pending builds:', allPendingBuilds.length);\n\n    return NextResponse.json({\n      totalJobs: allJobs.length,\n      activeJobs: jobNames.length,\n      pendingBuilds: allPendingBuilds.length,\n      data: allPendingBuilds\n    });\n\n  } catch (error) {\n    console.error('Error utama:', error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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"}}]
}