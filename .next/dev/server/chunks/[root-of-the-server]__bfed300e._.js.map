{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/fix/Naratel-Devops-Dashboard/src/app/api/jenkins/generate-file/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\n\nexport const dynamic = 'force-dynamic';\n\n/**\n * Generate Jenkinsfile content based on app configuration\n */\nfunction generateJenkinsfile({ appName, imageRepo, webuiUrl }) {\n    return `pipeline {\n    agent any\n\n    environment {\n        APP_NAME       = \"${appName}\"\n        DOCKER_IMAGE   = \"${imageRepo}\"\n        DOCKER_CRED_ID = \"docker-hub\"\n\n        // URL WebUI Base\n        WEBUI_API      = \"${webuiUrl}\"\n        \n        APP_VERSION    = \"\"\n    }\n\n    stages {\n        stage('Checkout & Get Version') {\n            steps {\n                script {\n                    checkout scm\n                    APP_VERSION = sh(\n                        script: \"git describe --tags --always --abbrev=0 || echo \\${BUILD_NUMBER}\",\n                        returnStdout: true\n                    ).trim()\n                    echo \"Building Version: \\${APP_VERSION}\"\n                }\n            }\n        }\n\n        stage('Build & Push Docker') {\n            steps {\n                script {\n                    docker.withRegistry('', \"\\${DOCKER_CRED_ID}\") {\n                        def customImage = docker.build(\"\\${DOCKER_IMAGE}:\\${APP_VERSION}\")\n                        customImage.push()\n                        customImage.push(\"latest\")\n                    }\n                }\n            }\n        }\n\n        stage('Deploy Testing (Ephemeral)') {\n            steps {\n                script {\n                    echo \"Triggering WebUI to create Ephemeral Testing Environment...\"\n                    def response = sh(script: \"\"\"\n                        curl -s -X POST \\${WEBUI_API}/api/jenkins/deploy-test \\\\\\\\\n                        -H \"Content-Type: application/json\" \\\\\\\\\n                        -d '{\"appName\": \"\\${APP_NAME}\", \"imageTag\": \"\\${APP_VERSION}\"}'\n                    \"\"\", returnStdout: true).trim()\n\n                    echo \"WebUI Response: \\${response}\"\n\n                    if (response.contains('\"error\"')) {\n                        error \"Failed to deploy testing env: \\${response}\"\n                    }\n\n                    echo \"Waiting for pods to be ready...\"\n                    sleep 60\n                }\n            }\n        }\n\n        stage('Integration Tests') {\n            steps {\n                script {\n                    echo \"Running Tests against Testing Env...\"\n                    // Add your test commands here\n                }\n            }\n        }\n\n        stage('Approval for Production') {\n            steps {\n                script {\n                    try {\n                        input message: \"Testing Done. Approve deploy \\${APP_VERSION} to Production?\",\n                              id: 'ApproveDeploy'\n                    } catch (Exception e) {\n                        currentBuild.result = 'ABORTED'\n                        error \"Deployment to Production Cancelled.\"\n                    }\n                }\n            }\n        }\n\n        stage('Deploy to Production') {\n            steps {\n                script {\n                    echo \"Updating Production Image Version...\"\n                    def response = sh(script: \"\"\"\n                        curl -s -X POST \\${WEBUI_API}/api/manifest/update-image \\\\\\\\\n                        -H \"Content-Type: application/json\" \\\\\\\\\n                        -d '{\"appName\": \"\\${APP_NAME}\", \"env\": \"prod\", \"imageTag\": \"\\${APP_VERSION}\"}'\n                    \"\"\", returnStdout: true).trim()\n\n                    echo \"WebUI Response: \\${response}\"\n\n                    if (response.contains('\"error\"')) {\n                        error \"Failed to update production: \\${response}\"\n                    }\n                }\n            }\n        }\n    }\n\n    post {\n        always {\n            script {\n                echo \"Cleaning up Ephemeral Testing Environment...\"\n                sh \"\"\"\n                    curl -s -X POST \\${WEBUI_API}/api/jenkins/destroy-test \\\\\\\\\n                    -H \"Content-Type: application/json\" \\\\\\\\\n                    -d '{\"appName\": \"\\${APP_NAME}\"}'\n                \"\"\"\n                cleanWs()\n            }\n        }\n    }\n}`;\n}\n\nexport async function GET(req) {\n    const { searchParams } = new URL(req.url);\n    const appName = searchParams.get('appName');\n    const imageRepo = searchParams.get('imageRepo');\n\n    if (!appName) {\n        return NextResponse.json({ error: 'Missing appName parameter' }, { status: 400 });\n    }\n\n    // Get WebUI URL from environment or use placeholder\n    const webuiUrl = process.env.NEXT_PUBLIC_APP_URL ||\n        process.env.NEXTAUTH_URL ||\n        'https://your-webui-url.example.com';\n\n    const jenkinsfile = generateJenkinsfile({\n        appName,\n        imageRepo: imageRepo || `devopsnaratel/${appName}`,\n        webuiUrl\n    });\n\n    return NextResponse.json({\n        jenkinsfile,\n        filename: 'Jenkinsfile',\n        appName\n    });\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,MAAM,UAAU;AAEvB;;CAEC,GACD,SAAS,oBAAoB,EAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,EAAE;IACzD,OAAO,CAAC;;;;0BAIc,EAAE,QAAQ;0BACV,EAAE,UAAU;;;;0BAIZ,EAAE,SAAS;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;CA6GpC,CAAC;AACF;AAEO,eAAe,IAAI,GAAG;IACzB,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,IAAI,GAAG;IACxC,MAAM,UAAU,aAAa,GAAG,CAAC;IACjC,MAAM,YAAY,aAAa,GAAG,CAAC;IAEnC,IAAI,CAAC,SAAS;QACV,OAAO,yLAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA4B,GAAG;YAAE,QAAQ;QAAI;IACnF;IAEA,oDAAoD;IACpD,MAAM,WAAW,QAAQ,GAAG,CAAC,mBAAmB,IAC5C,QAAQ,GAAG,CAAC,YAAY,IACxB;IAEJ,MAAM,cAAc,oBAAoB;QACpC;QACA,WAAW,aAAa,CAAC,cAAc,EAAE,SAAS;QAClD;IACJ;IAEA,OAAO,yLAAY,CAAC,IAAI,CAAC;QACrB;QACA,UAAU;QACV;IACJ;AACJ"}}]
}