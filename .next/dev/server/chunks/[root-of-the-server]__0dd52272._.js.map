{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/Naratel-Devops-Dashboard/src/app/api/manifest/delete/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { execSync } from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\nimport os from 'os';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function POST(req) {\n  const { appId, appName } = await req.json();\n  \n  if (!appId || !appName) {\n    return NextResponse.json({ error: \"Missing appId or appName\" }, { status: 400 });\n  }\n\n  const repoDirName = 'manifest-repo-workdir';\n  const repoPath = path.join(os.tmpdir(), repoDirName);\n  const registryPath = path.join(repoPath, 'registry.json');\n  const appsPath = path.join(repoPath, 'apps');\n  \n  const token = process.env.GITHUB_TOKEN;\n  const repoUrl = process.env.MANIFEST_REPO_URL;\n  const userName = process.env.GIT_USER_NAME || \"Naratel DevOps Dashboard\";\n  const userEmail = process.env.GIT_USER_EMAIL || \"devops@naratel.com\";\n\n  if (!repoUrl || !token) {\n      return NextResponse.json({ error: \"Configuration Error: MANIFEST_REPO_URL or GITHUB_TOKEN is missing.\" }, { status: 500 });\n  }\n\n  try {\n      // --- 1. Git Setup (Clone/Pull) ---\n      const authenticatedUrl = repoUrl.replace(\"https://\", `https://${token}@`);\n\n      if (!fs.existsSync(repoPath)) {\n          execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n          execSync(`git config user.name \"${userName}\"`, { cwd: repoPath });\n          execSync(`git config user.email \"${userEmail}\"`, { cwd: repoPath });\n      } else {\n          try {\n             execSync(`git fetch origin`, { cwd: repoPath });\n             execSync(`git reset --hard origin/main`, { cwd: repoPath });\n          } catch (e) {\n             // Re-clone if corrupt\n             fs.rmSync(repoPath, { recursive: true, force: true });\n             execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n             execSync(`git config user.name \"${userName}\"`, { cwd: repoPath });\n             execSync(`git config user.email \"${userEmail}\"`, { cwd: repoPath });\n          }\n      }\n\n      // --- 2. Remove Folders ---\n      // We look for folders starting with appName inside 'apps/'\n      // Expected patterns: {appName}-prod, {appName}-testing, {appName}-db-prod, {appName}-db-testing\n      \n      const foldersToDelete = [];\n      if (fs.existsSync(appsPath)) {\n          const files = fs.readdirSync(appsPath);\n          files.forEach(file => {\n              // Strict check to ensure we don't delete \"inventory-backend\" when deleting \"inventory\"\n              // The folders generated are exactly: appName + \"-prod\", \"-testing\", \"-db-prod\", \"-db-testing\"\n              if (file === `${appName}-prod` || \n                  file === `${appName}-testing` || \n                  file === `${appName}-db-prod` || \n                  file === `${appName}-db-testing`) {\n                  \n                  const fullPath = path.join(appsPath, file);\n                  fs.rmSync(fullPath, { recursive: true, force: true });\n                  foldersToDelete.push(file);\n              }\n          });\n      }\n\n      // --- 3. Update Registry ---\n      let registry = [];\n      if (fs.existsSync(registryPath)) {\n          try {\n              registry = JSON.parse(fs.readFileSync(registryPath, 'utf8'));\n          } catch (e) {\n              console.error(\"Failed to parse registry\", e);\n          }\n      }\n\n      const initialLength = registry.length;\n      registry = registry.filter(app => app.id !== appId);\n      \n      if (foldersToDelete.length === 0 && registry.length === initialLength) {\n          return NextResponse.json({ message: \"App not found or already deleted.\" });\n      }\n\n      fs.writeFileSync(registryPath, JSON.stringify(registry, null, 2));\n\n      // --- 4. Commit & Push ---\n      const commitMsg = `chore: delete application ${appName} (ID: ${appId})`;\n      \n      execSync(`git add .`, { cwd: repoPath });\n      try {\n          // Check if there are changes to commit\n          const status = execSync(`git status --porcelain`, { cwd: repoPath }).toString();\n          if (status.trim()) {\n              execSync(`git commit -m \"${commitMsg}\"`, { cwd: repoPath });\n              execSync(`git push origin main`, { cwd: repoPath });\n          } else {\n              return NextResponse.json({ message: \"No changes to commit (already clean).\" });\n          }\n      } catch (e) {\n          throw new Error(\"Git push failed: \" + e.message);\n      }\n\n      return NextResponse.json({ \n          message: `Successfully deleted ${appName}`,\n          deletedFolders: foldersToDelete\n      });\n\n  } catch (err) {\n      console.error(err);\n      return NextResponse.json({ error: err.message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}