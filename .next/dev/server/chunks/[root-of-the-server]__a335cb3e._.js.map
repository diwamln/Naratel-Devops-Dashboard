{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///home/rahan/Magang/cicd/Naratel-Devops-Dashboard/src/app/api/manifest/next-id/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { execSync } from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\nimport os from 'os';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET() {\n  const repoDirName = 'manifest-repo-workdir';\n  const repoPath = path.join(os.tmpdir(), repoDirName);\n  const registryPath = path.join(repoPath, 'registry.json');\n  \n  const token = process.env.GITHUB_TOKEN;\n  const repoUrl = process.env.MANIFEST_REPO_URL;\n  \n  // Default jika repo belum ada\n  if (!repoUrl || !token) {\n    return NextResponse.json({ nextId: \"001\" });\n  }\n\n  try {\n     // 1. Setup Git (Clone/Pull) untuk memastikan data terbaru\n     const authenticatedUrl = repoUrl.replace(\"https://\", `https://${token}@`);\n\n     if (!fs.existsSync(repoPath)) {\n        execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n     } else {\n        try {\n           execSync(`git fetch origin`, { cwd: repoPath });\n           execSync(`git reset --hard origin/main`, { cwd: repoPath });\n        } catch (e) {\n           // Re-clone jika corrupt\n           fs.rmSync(repoPath, { recursive: true, force: true });\n           execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n        }\n     }\n\n     // 2. Baca registry.json\n     let registry = [];\n     if (fs.existsSync(registryPath)) {\n        const content = fs.readFileSync(registryPath, 'utf8');\n        registry = JSON.parse(content);\n     }\n\n     // 3. Cari ID Maksimal\n     let maxId = 0;\n     registry.forEach(app => {\n        const idNum = parseInt(app.id);\n        if (!isNaN(idNum) && idNum > maxId) {\n            maxId = idNum;\n        }\n     });\n\n     const nextId = String(maxId + 1).padStart(3, '0');\n     return NextResponse.json({ nextId, registry });\n\n  } catch (error) {\n    console.error(\"Error in next-id:\", error);\n    // Fallback jika gagal\n    return NextResponse.json({ nextId: \"001\", error: error.message });\n  }\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,MAAM,UAAU;AAEhB,eAAe;IACpB,MAAM,cAAc;IACpB,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,wGAAE,CAAC,MAAM,IAAI;IACxC,MAAM,eAAe,4GAAI,CAAC,IAAI,CAAC,UAAU;IAEzC,MAAM,QAAQ,QAAQ,GAAG,CAAC,YAAY;IACtC,MAAM,UAAU,QAAQ,GAAG,CAAC,iBAAiB;IAE7C,8BAA8B;IAC9B,IAAI,CAAC,WAAW,CAAC,OAAO;QACtB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,QAAQ;QAAM;IAC3C;IAEA,IAAI;QACD,0DAA0D;QAC1D,MAAM,mBAAmB,QAAQ,OAAO,CAAC,YAAY,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAExE,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,WAAW;YAC3B,IAAA,+HAAQ,EAAC,CAAC,UAAU,EAAE,iBAAiB,CAAC,EAAE,UAAU;QACvD,OAAO;YACJ,IAAI;gBACD,IAAA,+HAAQ,EAAC,CAAC,gBAAgB,CAAC,EAAE;oBAAE,KAAK;gBAAS;gBAC7C,IAAA,+HAAQ,EAAC,CAAC,4BAA4B,CAAC,EAAE;oBAAE,KAAK;gBAAS;YAC5D,EAAE,OAAO,GAAG;gBACT,wBAAwB;gBACxB,wGAAE,CAAC,MAAM,CAAC,UAAU;oBAAE,WAAW;oBAAM,OAAO;gBAAK;gBACnD,IAAA,+HAAQ,EAAC,CAAC,UAAU,EAAE,iBAAiB,CAAC,EAAE,UAAU;YACvD;QACH;QAEA,wBAAwB;QACxB,IAAI,WAAW,EAAE;QACjB,IAAI,wGAAE,CAAC,UAAU,CAAC,eAAe;YAC9B,MAAM,UAAU,wGAAE,CAAC,YAAY,CAAC,cAAc;YAC9C,WAAW,KAAK,KAAK,CAAC;QACzB;QAEA,sBAAsB;QACtB,IAAI,QAAQ;QACZ,SAAS,OAAO,CAAC,CAAA;YACd,MAAM,QAAQ,SAAS,IAAI,EAAE;YAC7B,IAAI,CAAC,MAAM,UAAU,QAAQ,OAAO;gBAChC,QAAQ;YACZ;QACH;QAEA,MAAM,SAAS,OAAO,QAAQ,GAAG,QAAQ,CAAC,GAAG;QAC7C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;YAAQ;QAAS;IAE/C,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,sBAAsB;QACtB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,QAAQ;YAAO,OAAO,MAAM,OAAO;QAAC;IACjE;AACF"}}]
}