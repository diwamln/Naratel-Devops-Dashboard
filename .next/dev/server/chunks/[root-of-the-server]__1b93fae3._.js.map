{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/fix/Naratel-Devops-Dashboard/src/lib/gitMutex.js"],"sourcesContent":["import { Mutex } from 'async-mutex';\n\n// Shared mutex instance to prevent race conditions during Git operations\nexport const gitMutex = new Mutex();\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,WAAW,IAAI,4LAAK"}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/fix/Naratel-Devops-Dashboard/src/app/api/jenkins/destroy-test/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { execSync } from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\nimport os from 'os';\nimport { gitMutex } from '@/lib/gitMutex';\n\nexport async function POST(req) {\n  try {\n    const data = await req.json();\n    const { appName } = data;\n\n    if (!appName) {\n        return NextResponse.json({ error: \"appName is required\" }, { status: 400 });\n    }\n\n    const repoDirName = 'manifest-repo-workdir';\n    const repoPath = path.join(os.tmpdir(), repoDirName);\n    \n    const token = process.env.GITHUB_TOKEN;\n    const repoUrl = process.env.MANIFEST_REPO_URL;\n    const userName = process.env.GIT_USER_NAME || \"Naratel DevOps Dashboard\";\n    const userEmail = process.env.GIT_USER_EMAIL || \"devops@naratel.com\";\n\n    if (!repoUrl || !token) {\n        return NextResponse.json({ error: \"Configuration Error\" }, { status: 500 });\n    }\n\n    return await gitMutex.runExclusive(async () => {\n        // 1. Git Setup\n        const authenticatedUrl = repoUrl.replace(\"https://\", `https://${token}@`);\n        if (!fs.existsSync(repoPath)) {\n            execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n            execSync(`git config user.name \"${userName}\"`, { cwd: repoPath });\n            execSync(`git config user.email \"${userEmail}\"`, { cwd: repoPath });\n        } else {\n            execSync(`git fetch origin`, { cwd: repoPath });\n            execSync(`git reset --hard origin/main`, { cwd: repoPath });\n        }\n\n        const registryPath = path.join(repoPath, 'registry.json');\n        let appId = null;\n        let registry = [];\n        let releasedDomain = null;\n\n        if (fs.existsSync(registryPath)) {\n            try {\n                registry = JSON.parse(fs.readFileSync(registryPath, 'utf8'));\n                const appIndex = registry.findIndex(a => a.name === appName);\n                if (appIndex !== -1) {\n                    appId = registry[appIndex].id;\n                    \n                    // Release Domain\n                    if (registry[appIndex].testDomain) {\n                        releasedDomain = registry[appIndex].testDomain;\n                        console.log(`[Domain] Releasing domain ${releasedDomain} for ${appName}`);\n                        registry[appIndex].testDomain = null; // Release it\n                        \n                        // Save Registry immediately\n                        fs.writeFileSync(registryPath, JSON.stringify(registry, null, 2));\n                    }\n                }\n            } catch (e) { console.error(\"Failed to parse registry\", e); }\n        }\n\n        const foldersToDelete = [\n            path.join(repoPath, 'apps', `${appId}-${appName}-testing`),\n            path.join(repoPath, 'apps', `${appId}-db-${appName}-testing`),\n            path.join(repoPath, 'apps', `${appName}-testing`),\n            path.join(repoPath, 'apps', `${appName}-db-testing`)\n        ];\n\n        let deletedCount = 0;\n\n        foldersToDelete.forEach(folder => {\n            if (fs.existsSync(folder)) {\n                fs.rmSync(folder, { recursive: true, force: true });\n                deletedCount++;\n                console.log(`Deleted: ${folder}`);\n            }\n        });\n\n        if (deletedCount === 0 && !releasedDomain) {\n            return NextResponse.json({ message: \"No testing environments found to destroy.\" });\n        }\n\n        // 2. Commit & Push\n        execSync(`git add .`, { cwd: repoPath });\n        const commitMsg = `chore: destroy ephemeral testing for ${appName}`;\n        \n        try {\n             execSync(`git commit -m \"${commitMsg}\"`, { cwd: repoPath });\n             execSync(`git push origin main`, { cwd: repoPath });\n        } catch (e) {\n             if (e.message.includes('nothing to commit')) {\n                 return NextResponse.json({ message: \"Already clean.\" });\n             }\n             throw e;\n        }\n\n        return NextResponse.json({ message: \"Ephemeral environment destroyed successfully.\" });\n\n    });\n\n  } catch (err) {\n      console.error(err);\n      return NextResponse.json({ error: err.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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"}}]
}