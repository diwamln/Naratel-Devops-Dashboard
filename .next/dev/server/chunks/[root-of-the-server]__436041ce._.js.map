{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/fix/Naratel-Devops-Dashboard/src/lib/gitMutex.js"],"sourcesContent":["import { Mutex } from 'async-mutex';\n\n// Shared mutex instance to prevent race conditions during Git operations\nexport const gitMutex = new Mutex();\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,WAAW,IAAI,4LAAK"}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/fix/Naratel-Devops-Dashboard/src/app/api/manifest/next-id/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { execSync } from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\nimport os from 'os';\nimport yaml from 'js-yaml';\nimport { gitMutex } from '@/lib/gitMutex';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET() {\n  console.log('--- GET /api/manifest/next-id ---');\n  return await gitMutex.runExclusive(async () => {\n      const repoDirName = 'manifest-repo-workdir';\n      const repoPath = path.join(os.tmpdir(), repoDirName);\n      const registryPath = path.join(repoPath, 'registry.json');\n      \n      const token = process.env.GITHUB_TOKEN;\n      const repoUrl = process.env.MANIFEST_REPO_URL;\n      \n      console.log(`Token: ${token ? 'Loaded' : 'Missing'}`);\n      console.log(`Repo URL: ${repoUrl || 'Missing'}`);\n\n      // Default jika repo belum ada\n      if (!repoUrl || !token) {\n        console.log('Missing repoUrl or token, returning default.');\n        return NextResponse.json({ nextId: \"001\", registry: [] }); // Kembalikan registry kosong\n      }\n\n      try {\n        // 1. Setup Git (Clone/Pull) untuk memastikan data terbaru\n        const authenticatedUrl = repoUrl.replace(\"https://\", `https://${token}@`);\n\n        if (!fs.existsSync(repoPath)) {\n            console.log(`Cloning repo to ${repoPath}`);\n            execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n        } else {\n            console.log(`Fetching and resetting repo at ${repoPath}`);\n            try {\n              execSync(`git fetch origin`, { cwd: repoPath });\n              execSync(`git reset --hard origin/main`, { cwd: repoPath });\n            } catch (e) {\n              console.warn('Git reset failed, re-cloning.', e.message);\n              fs.rmSync(repoPath, { recursive: true, force: true });\n              execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n            }\n        }\n        console.log('Git operations successful.');\n\n        // 2. Baca registry.json\n        let registry = [];\n        if (fs.existsSync(registryPath)) {\n            const content = fs.readFileSync(registryPath, 'utf8');\n            console.log('registry.json content:', content);\n            try {\n              registry = JSON.parse(content);\n              if (!Array.isArray(registry)) {\n                console.error('ERROR: registry.json is not an array!');\n                registry = [];\n              }\n            } catch (e) {\n              console.error('ERROR: Failed to parse registry.json!', e);\n              registry = [];\n            }\n        } else {\n          console.warn('WARN: registry.json not found!');\n        }\n\n        console.log(`Found ${registry.length} apps in registry.`);\n\n        // 3. Enrich Registry with Real Ingress Data\n        const enrichedRegistry = registry.map((app, index) => {\n            if (!app || typeof app !== 'object') {\n              console.warn(`Item at index ${index} is not a valid object, skipping.`);\n              return null; // Akan difilter nanti\n            }\n            if (!app.name) {\n              console.warn(`App at index ${index} is missing a 'name', skipping.`, app);\n              return null;\n            }\n\n            const prodValuesPath = path.join(repoPath, 'apps', `${app.id}-${app.name}-prod`, 'values.yaml');\n            const testValuesPath = path.join(repoPath, 'apps', `${app.id}-${app.name}-testing`, 'values.yaml');\n            \n            // Legacy Fallback\n            const legacyProdValuesPath = path.join(repoPath, 'apps', `${app.name}-prod`, 'values.yaml');\n            const legacyTestValuesPath = path.join(repoPath, 'apps', `${app.name}-testing`, 'values.yaml');\n            \n            let prodHost = null;\n            let testHost = null;\n\n            // Read Prod\n            if (fs.existsSync(prodValuesPath)) {\n                try {\n                    const doc = yaml.load(fs.readFileSync(prodValuesPath, 'utf8'));\n                    if (doc.ingress && doc.ingress.enabled && doc.ingress.hosts && doc.ingress.hosts.length > 0) {\n                        prodHost = doc.ingress.hosts[0].host;\n                    }\n                } catch (e) { console.warn(`Failed to read prod values for ${app.name}`, e.message); }\n            } else if (fs.existsSync(legacyProdValuesPath)) {\n                try {\n                    const doc = yaml.load(fs.readFileSync(legacyProdValuesPath, 'utf8'));\n                    if (doc.ingress && doc.ingress.enabled && doc.ingress.hosts && doc.ingress.hosts.length > 0) {\n                        prodHost = doc.ingress.hosts[0].host;\n                    }\n                } catch (e) { console.warn(`Failed to read legacy prod values for ${app.name}`, e.message); }\n            }\n\n            // Read Testing\n            if (fs.existsSync(testValuesPath)) {\n                try {\n                    const doc = yaml.load(fs.readFileSync(testValuesPath, 'utf8'));\n                    if (doc.ingress && doc.ingress.enabled && doc.ingress.hosts && doc.ingress.hosts.length > 0) {\n                        testHost = doc.ingress.hosts[0].host;\n                    }\n                } catch (e) { console.warn(`Failed to read test values for ${app.name}`, e.message); }\n            } else if (fs.existsSync(legacyTestValuesPath)) {\n                try {\n                    const doc = yaml.load(fs.readFileSync(legacyTestValuesPath, 'utf8'));\n                    if (doc.ingress && doc.ingress.enabled && doc.ingress.hosts && doc.ingress.hosts.length > 0) {\n                        testHost = doc.ingress.hosts[0].host;\n                    }\n                } catch (e) { console.warn(`Failed to read legacy test values for ${app.name}`, e.message); }\n            }\n\n            return {\n                ...app,\n                liveIngressProd: prodHost,\n                liveIngressTest: testHost\n            };\n        }).filter(Boolean); // Hapus semua item null\n\n        console.log(`Enriched ${enrichedRegistry.length} apps successfully.`);\n\n        // 4. Cari ID Maksimal\n        let maxId = 0;\n        enrichedRegistry.forEach(app => {\n            const idNum = parseInt(app.id);\n            if (!isNaN(idNum) && idNum > maxId) {\n                maxId = idNum;\n            }\n        });\n\n        const nextId = String(maxId + 1).padStart(3, '0');\n        console.log(`Calculated nextId: ${nextId}`);\n        \n        return NextResponse.json({ nextId, registry: enrichedRegistry });\n\n      } catch (error) {\n        console.error(\"FATAL: Unhandled error in next-id:\", error);\n        // Fallback jika gagal parah\n        return NextResponse.json(\n          { nextId: \"001\", registry: [], error: error.message },\n          { status: 500 }\n        );\n      }\n  });\n}"],"names":[],"mappings":"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"}}]
}