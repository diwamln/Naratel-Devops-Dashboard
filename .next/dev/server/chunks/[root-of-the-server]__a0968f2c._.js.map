{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/webui-devops/Naratel-Devops-Dashboard/src/lib/gitMutex.js"],"sourcesContent":["import { Mutex } from 'async-mutex';\n\n// Shared mutex instance to prevent race conditions during Git operations\nexport const gitMutex = new Mutex();\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,WAAW,IAAI,wMAAK"}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/webui-devops/Naratel-Devops-Dashboard/src/app/api/jenkins/deploy-test/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { execSync } from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\nimport os from 'os';\nimport yaml from 'js-yaml'; // Pastikan package ini ada (biasanya standar di Next.js projects atau perlu install)\nimport { gitMutex } from '@/lib/gitMutex';\n\n// Jika js-yaml belum ada, kita pakai basic parsing/string manipulation atau asumsi environment sudah punya.\n// Namun untuk keamanan, saya akan gunakan simple read/replace jika import gagal, tapi mari kita coba import dulu.\n\nexport async function POST(req) {\n  try {\n    const data = await req.json();\n    const { appName, imageTag } = data;\n\n    if (!appName) {\n        return NextResponse.json({ error: \"appName is required\" }, { status: 400 });\n    }\n\n    const repoDirName = 'manifest-repo-workdir';\n    const repoPath = path.join(os.tmpdir(), repoDirName);\n    const registryPath = path.join(repoPath, 'registry.json');\n    \n    const token = process.env.GITHUB_TOKEN;\n    const repoUrl = process.env.MANIFEST_REPO_URL;\n    const userName = process.env.GIT_USER_NAME || \"Naratel DevOps Dashboard\";\n    const userEmail = process.env.GIT_USER_EMAIL || \"devops@naratel.com\";\n\n    if (!repoUrl || !token) {\n        return NextResponse.json({ error: \"Configuration Error\" }, { status: 500 });\n    }\n\n    return await gitMutex.runExclusive(async () => {\n        // 1. Git Setup\n        const authenticatedUrl = repoUrl.replace(\"https://\", `https://${token}@`);\n        if (!fs.existsSync(repoPath)) {\n            execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n            execSync(`git config user.name \"${userName}\"`, { cwd: repoPath });\n            execSync(`git config user.email \"${userEmail}\"`, { cwd: repoPath });\n        } else {\n            execSync(`git fetch origin`, { cwd: repoPath });\n            execSync(`git reset --hard origin/main`, { cwd: repoPath });\n        }\n\n        // 2. Get App ID from Registry\n        let registry = [];\n        if (fs.existsSync(registryPath)) {\n            registry = JSON.parse(fs.readFileSync(registryPath, 'utf8'));\n        }\n        const appEntry = registry.find(r => r.name === appName);\n        \n        if (!appEntry) {\n            return NextResponse.json({ error: `App ${appName} not found in registry` }, { status: 404 });\n        }\n        \n        const appId = appEntry.id;\n        const dbType = appEntry.db; // 'none', 'postgres', 'mariadb'\n\n        const generatedFolders = [];\n\n        // --- HELPER: Deploy Component (App or DB) ---\n        const deployComponent = (role, suffixProd, suffixTest) => {\n            const prodFolder = path.join(repoPath, 'apps', `${appName}${suffixProd}`);\n            const testFolder = path.join(repoPath, 'apps', `${appName}${suffixTest}`);\n            \n            if (!fs.existsSync(prodFolder)) {\n                console.warn(`Prod folder not found: ${prodFolder}`);\n                return;\n            }\n\n            if (!fs.existsSync(testFolder)) {\n                fs.mkdirSync(testFolder, { recursive: true });\n            }\n\n            // A. Copy Secrets (Encrypted)\n            const prodSecret = path.join(prodFolder, 'secrets.yaml');\n            if (fs.existsSync(prodSecret)) {\n                fs.copyFileSync(prodSecret, path.join(testFolder, 'secrets.yaml'));\n            }\n\n            // B. Read & Modify Values\n            const prodValuesPath = path.join(prodFolder, 'values.yaml');\n            if (fs.existsSync(prodValuesPath)) {\n                const prodValContent = fs.readFileSync(prodValuesPath, 'utf8');\n                let values = yaml.load(prodValContent);\n\n                // Modify for Testing\n                const isDb = suffixProd.includes('db');\n                // Format: ID-db-APPNAME-testing OR ID-APPNAME-testing\n                values.namespace = `${appId}-${isDb ? 'db-' : ''}${appName}-testing`; \n                values.app.env = 'testing';\n                \n                // Override Image Tag if provided (Only for App)\n                if (role === 'app' && imageTag) {\n                    values.image.tag = imageTag;\n                }\n\n                // Handle Ingress (Add 'test-' prefix)\n                if (values.ingress && values.ingress.enabled && values.ingress.hosts) {\n                    values.ingress.hosts = values.ingress.hosts.map(h => ({\n                        ...h,\n                        host: `test-${h.host}`\n                    }));\n                }\n\n                // C. Special Handling: DB Connection for APP\n                if (role === 'app' && dbType !== 'none') {\n                    // FQDN Calculation\n                    // DB Service: svc-db-{appName}-{appId}\n                    // DB Namespace: {appId}-db-{appName}-testing\n                    const dbFqdn = `svc-db-${appName}-${appId}.${appId}-db-${appName}-testing.svc.cluster.local`;\n                    \n                    if (!values.extraEnv) values.extraEnv = [];\n                    \n                    // Remove existing DB_HOST in extraEnv if any\n                    values.extraEnv = values.extraEnv.filter(e => e.name !== 'DB_HOST');\n                    \n                    // Add new DB_HOST\n                    values.extraEnv.push({\n                        name: \"DB_HOST\",\n                        value: dbFqdn\n                    });\n                }\n\n                // D. Override Migration Command for Testing (Auto-Seed)\n                if (values.migration && values.migration.enabled) {\n                    // Default laravel/php command, adjust if you use different stack\n                    // Force seed for testing environment\n                    values.migration.command = \"php artisan migrate --seed --force\";\n                }\n\n                // Write Values\n                fs.writeFileSync(path.join(testFolder, 'values.yaml'), yaml.dump(values));\n                generatedFolders.push(`${appName}${suffixTest}`);\n            }\n        };\n\n        // 3. Deploy App\n        deployComponent('app', '-prod', '-testing');\n\n        // 4. Deploy DB (if exists)\n        if (dbType !== 'none') {\n            deployComponent('db', '-db-prod', '-db-testing');\n        }\n\n        if (generatedFolders.length === 0) {\n             return NextResponse.json({ error: \"No prod manifests found to clone.\" }, { status: 400 });\n        }\n\n        // 5. Commit & Push\n        execSync(`git add .`, { cwd: repoPath });\n        const commitMsg = `feat: deploy ephemeral testing for ${appName} (Build ${imageTag || 'latest'})`;\n        \n        try {\n             execSync(`git commit -m \"${commitMsg}\"`, { cwd: repoPath });\n             execSync(`git push origin main`, { cwd: repoPath });\n        } catch (e) {\n             if (e.message.includes('nothing to commit')) {\n                 return NextResponse.json({ message: \"Environment already up-to-date.\" });\n             }\n             throw e;\n        }\n\n        return NextResponse.json({ \n            message: \"Ephemeral environment deployed\", \n            folders: generatedFolders,\n            namespaceApp: `${appId}-${appName}-testing`,\n            namespaceDb: dbType !== 'none' ? `${appId}-${appName}-db-testing` : null\n        });\n\n    });\n\n  } catch (err) {\n      console.error(err);\n      return NextResponse.json({ error: err.message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AACA,0VAA4B,qFAAqF;AACjH;;;;;;;;AAKO,eAAe,KAAK,GAAG;IAC5B,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,OAAO,EAAE,QAAQ,EAAE,GAAG;QAE9B,IAAI,CAAC,SAAS;YACV,OAAO,qMAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC7E;QAEA,MAAM,cAAc;QACpB,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,wGAAE,CAAC,MAAM,IAAI;QACxC,MAAM,eAAe,4GAAI,CAAC,IAAI,CAAC,UAAU;QAEzC,MAAM,QAAQ,QAAQ,GAAG,CAAC,YAAY;QACtC,MAAM,UAAU,QAAQ,GAAG,CAAC,iBAAiB;QAC7C,MAAM,WAAW,QAAQ,GAAG,CAAC,aAAa,IAAI;QAC9C,MAAM,YAAY,QAAQ,GAAG,CAAC,cAAc,IAAI;QAEhD,IAAI,CAAC,WAAW,CAAC,OAAO;YACpB,OAAO,qMAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC7E;QAEA,OAAO,MAAM,yLAAQ,CAAC,YAAY,CAAC;YAC/B,eAAe;YACf,MAAM,mBAAmB,QAAQ,OAAO,CAAC,YAAY,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;YACxE,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,WAAW;gBAC1B,IAAA,+HAAQ,EAAC,CAAC,UAAU,EAAE,iBAAiB,CAAC,EAAE,UAAU;gBACpD,IAAA,+HAAQ,EAAC,CAAC,sBAAsB,EAAE,SAAS,CAAC,CAAC,EAAE;oBAAE,KAAK;gBAAS;gBAC/D,IAAA,+HAAQ,EAAC,CAAC,uBAAuB,EAAE,UAAU,CAAC,CAAC,EAAE;oBAAE,KAAK;gBAAS;YACrE,OAAO;gBACH,IAAA,+HAAQ,EAAC,CAAC,gBAAgB,CAAC,EAAE;oBAAE,KAAK;gBAAS;gBAC7C,IAAA,+HAAQ,EAAC,CAAC,4BAA4B,CAAC,EAAE;oBAAE,KAAK;gBAAS;YAC7D;YAEA,8BAA8B;YAC9B,IAAI,WAAW,EAAE;YACjB,IAAI,wGAAE,CAAC,UAAU,CAAC,eAAe;gBAC7B,WAAW,KAAK,KAAK,CAAC,wGAAE,CAAC,YAAY,CAAC,cAAc;YACxD;YACA,MAAM,WAAW,SAAS,IAAI,CAAC,CAAA,IAAK,EAAE,IAAI,KAAK;YAE/C,IAAI,CAAC,UAAU;gBACX,OAAO,qMAAY,CAAC,IAAI,CAAC;oBAAE,OAAO,CAAC,IAAI,EAAE,QAAQ,sBAAsB,CAAC;gBAAC,GAAG;oBAAE,QAAQ;gBAAI;YAC9F;YAEA,MAAM,QAAQ,SAAS,EAAE;YACzB,MAAM,SAAS,SAAS,EAAE,EAAE,gCAAgC;YAE5D,MAAM,mBAAmB,EAAE;YAE3B,+CAA+C;YAC/C,MAAM,kBAAkB,CAAC,MAAM,YAAY;gBACvC,MAAM,aAAa,4GAAI,CAAC,IAAI,CAAC,UAAU,QAAQ,GAAG,UAAU,YAAY;gBACxE,MAAM,aAAa,4GAAI,CAAC,IAAI,CAAC,UAAU,QAAQ,GAAG,UAAU,YAAY;gBAExE,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,aAAa;oBAC5B,QAAQ,IAAI,CAAC,CAAC,uBAAuB,EAAE,YAAY;oBACnD;gBACJ;gBAEA,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,aAAa;oBAC5B,wGAAE,CAAC,SAAS,CAAC,YAAY;wBAAE,WAAW;oBAAK;gBAC/C;gBAEA,8BAA8B;gBAC9B,MAAM,aAAa,4GAAI,CAAC,IAAI,CAAC,YAAY;gBACzC,IAAI,wGAAE,CAAC,UAAU,CAAC,aAAa;oBAC3B,wGAAE,CAAC,YAAY,CAAC,YAAY,4GAAI,CAAC,IAAI,CAAC,YAAY;gBACtD;gBAEA,0BAA0B;gBAC1B,MAAM,iBAAiB,4GAAI,CAAC,IAAI,CAAC,YAAY;gBAC7C,IAAI,wGAAE,CAAC,UAAU,CAAC,iBAAiB;oBAC/B,MAAM,iBAAiB,wGAAE,CAAC,YAAY,CAAC,gBAAgB;oBACvD,IAAI,SAAS,mNAAI,CAAC,IAAI,CAAC;oBAEvB,qBAAqB;oBACrB,MAAM,OAAO,WAAW,QAAQ,CAAC;oBACjC,sDAAsD;oBACtD,OAAO,SAAS,GAAG,GAAG,MAAM,CAAC,EAAE,OAAO,QAAQ,KAAK,QAAQ,QAAQ,CAAC;oBACpE,OAAO,GAAG,CAAC,GAAG,GAAG;oBAEjB,gDAAgD;oBAChD,IAAI,SAAS,SAAS,UAAU;wBAC5B,OAAO,KAAK,CAAC,GAAG,GAAG;oBACvB;oBAEA,sCAAsC;oBACtC,IAAI,OAAO,OAAO,IAAI,OAAO,OAAO,CAAC,OAAO,IAAI,OAAO,OAAO,CAAC,KAAK,EAAE;wBAClE,OAAO,OAAO,CAAC,KAAK,GAAG,OAAO,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA,IAAK,CAAC;gCAClD,GAAG,CAAC;gCACJ,MAAM,CAAC,KAAK,EAAE,EAAE,IAAI,EAAE;4BAC1B,CAAC;oBACL;oBAEA,6CAA6C;oBAC7C,IAAI,SAAS,SAAS,WAAW,QAAQ;wBACrC,mBAAmB;wBACnB,uCAAuC;wBACvC,6CAA6C;wBAC7C,MAAM,SAAS,CAAC,OAAO,EAAE,QAAQ,CAAC,EAAE,MAAM,CAAC,EAAE,MAAM,IAAI,EAAE,QAAQ,0BAA0B,CAAC;wBAE5F,IAAI,CAAC,OAAO,QAAQ,EAAE,OAAO,QAAQ,GAAG,EAAE;wBAE1C,6CAA6C;wBAC7C,OAAO,QAAQ,GAAG,OAAO,QAAQ,CAAC,MAAM,CAAC,CAAA,IAAK,EAAE,IAAI,KAAK;wBAEzD,kBAAkB;wBAClB,OAAO,QAAQ,CAAC,IAAI,CAAC;4BACjB,MAAM;4BACN,OAAO;wBACX;oBACJ;oBAEA,wDAAwD;oBACxD,IAAI,OAAO,SAAS,IAAI,OAAO,SAAS,CAAC,OAAO,EAAE;wBAC9C,iEAAiE;wBACjE,qCAAqC;wBACrC,OAAO,SAAS,CAAC,OAAO,GAAG;oBAC/B;oBAEA,eAAe;oBACf,wGAAE,CAAC,aAAa,CAAC,4GAAI,CAAC,IAAI,CAAC,YAAY,gBAAgB,mNAAI,CAAC,IAAI,CAAC;oBACjE,iBAAiB,IAAI,CAAC,GAAG,UAAU,YAAY;gBACnD;YACJ;YAEA,gBAAgB;YAChB,gBAAgB,OAAO,SAAS;YAEhC,2BAA2B;YAC3B,IAAI,WAAW,QAAQ;gBACnB,gBAAgB,MAAM,YAAY;YACtC;YAEA,IAAI,iBAAiB,MAAM,KAAK,GAAG;gBAC9B,OAAO,qMAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAoC,GAAG;oBAAE,QAAQ;gBAAI;YAC5F;YAEA,mBAAmB;YACnB,IAAA,+HAAQ,EAAC,CAAC,SAAS,CAAC,EAAE;gBAAE,KAAK;YAAS;YACtC,MAAM,YAAY,CAAC,mCAAmC,EAAE,QAAQ,QAAQ,EAAE,YAAY,SAAS,CAAC,CAAC;YAEjG,IAAI;gBACC,IAAA,+HAAQ,EAAC,CAAC,eAAe,EAAE,UAAU,CAAC,CAAC,EAAE;oBAAE,KAAK;gBAAS;gBACzD,IAAA,+HAAQ,EAAC,CAAC,oBAAoB,CAAC,EAAE;oBAAE,KAAK;gBAAS;YACtD,EAAE,OAAO,GAAG;gBACP,IAAI,EAAE,OAAO,CAAC,QAAQ,CAAC,sBAAsB;oBACzC,OAAO,qMAAY,CAAC,IAAI,CAAC;wBAAE,SAAS;oBAAkC;gBAC1E;gBACA,MAAM;YACX;YAEA,OAAO,qMAAY,CAAC,IAAI,CAAC;gBACrB,SAAS;gBACT,SAAS;gBACT,cAAc,GAAG,MAAM,CAAC,EAAE,QAAQ,QAAQ,CAAC;gBAC3C,aAAa,WAAW,SAAS,GAAG,MAAM,CAAC,EAAE,QAAQ,WAAW,CAAC,GAAG;YACxE;QAEJ;IAEF,EAAE,OAAO,KAAK;QACV,QAAQ,KAAK,CAAC;QACd,OAAO,qMAAY,CAAC,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnE;AACF"}}]
}