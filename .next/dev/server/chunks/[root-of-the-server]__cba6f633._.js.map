{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/fix/Naratel-Devops-Dashboard/src/lib/gitMutex.js"],"sourcesContent":["import { Mutex } from 'async-mutex';\n\n// Shared mutex instance to prevent race conditions during Git operations\nexport const gitMutex = new Mutex();\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,WAAW,IAAI,4LAAK"}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/fix/Naratel-Devops-Dashboard/src/app/api/jenkins/deploy-test/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { execSync } from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\nimport os from 'os';\nimport yaml from 'js-yaml'; \nimport { gitMutex } from '@/lib/gitMutex';\n\nexport async function POST(req) {\n  try {\n    const data = await req.json();\n    const { appName, imageTag } = data;\n\n    if (!appName) {\n        return NextResponse.json({ error: \"appName is required\" }, { status: 400 });\n    }\n\n    const repoDirName = 'manifest-repo-workdir';\n    const repoPath = path.join(os.tmpdir(), repoDirName);\n    const registryPath = path.join(repoPath, 'registry.json');\n    const configPath = path.join(repoPath, 'config.json');\n    \n    const token = process.env.GITHUB_TOKEN;\n    const repoUrl = process.env.MANIFEST_REPO_URL;\n    const userName = process.env.GIT_USER_NAME || \"Naratel DevOps Dashboard\";\n    const userEmail = process.env.GIT_USER_EMAIL || \"devops@naratel.com\";\n\n    if (!repoUrl || !token) {\n        return NextResponse.json({ error: \"Configuration Error\" }, { status: 500 });\n    }\n\n    return await gitMutex.runExclusive(async () => {\n        // 1. Git Setup\n        const authenticatedUrl = repoUrl.replace(\"https://\", `https://${token}@`);\n        if (!fs.existsSync(repoPath)) {\n            execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n            execSync(`git config user.name \"${userName}\"`, { cwd: repoPath });\n            execSync(`git config user.email \"${userEmail}\"`, { cwd: repoPath });\n        } else {\n            execSync(`git fetch origin`, { cwd: repoPath });\n            execSync(`git reset --hard origin/main`, { cwd: repoPath });\n        }\n\n        // 2. Get App ID from Registry & Check Domain Availability\n        let registry = [];\n        if (fs.existsSync(registryPath)) {\n            registry = JSON.parse(fs.readFileSync(registryPath, 'utf8'));\n        }\n        \n        const appIndex = registry.findIndex(r => r.name === appName);\n        if (appIndex === -1) {\n            return NextResponse.json({ error: `App ${appName} not found in registry` }, { status: 404 });\n        }\n        \n        const appEntry = registry[appIndex];\n        const appId = appEntry.id;\n        const dbType = appEntry.db; \n\n        // --- DOMAIN ALLOCATION LOGIC ---\n        let selectedDomain = null;\n        let domainPool = [];\n        if (fs.existsSync(configPath)) {\n            const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));\n            domainPool = config.testDomains || [];\n        }\n\n        if (domainPool.length > 0) {\n            if (appEntry.testDomain && domainPool.includes(appEntry.testDomain)) {\n                selectedDomain = appEntry.testDomain;\n            } else {\n                const usedDomains = registry.map(r => r.testDomain).filter(d => d);\n                selectedDomain = domainPool.find(d => !usedDomains.includes(d));\n                \n                if (!selectedDomain) {\n                    return NextResponse.json({ \n                        error: \"No testing domains available. Please destroy an existing test environment to free up a slot.\" \n                    }, { status: 503 });\n                }\n                registry[appIndex].testDomain = selectedDomain;\n            }\n        }\n\n        const generatedFolders = [];\n\n        // --- HELPER: Deploy Component (App or DB) ---\n        const deployComponent = (role, suffixProd, suffixTest) => {\n            const isDb = role === 'db';\n            const dbPrefix = isDb ? 'db-' : '';\n            \n            let prodFolder = path.join(repoPath, 'apps', `${appId}-${dbPrefix}${appName}${suffixProd}`);\n            let testFolder = path.join(repoPath, 'apps', `${appId}-${dbPrefix}${appName}${suffixTest}`);\n            \n            // Note: Folder testing mungkin sudah ada jika standby secret sudah di-generate\n            if (!fs.existsSync(testFolder)) {\n                fs.mkdirSync(testFolder, { recursive: true });\n            }\n\n            // A. Handle Secrets (ABSOLUTE REQUIREMENT)\n            const testSecretPath = path.join(testFolder, 'secrets.yaml');\n            \n            if (!fs.existsSync(testSecretPath)) {\n                throw new Error(`Standby secret for ${role} (${appName}${suffixTest}) not found in repository. Please configure testing secrets first.`);\n            }\n            \n            console.log(`[Secrets] Using verified standby secrets for ${appName}${suffixTest}`);\n\n            // B. Read & Modify Values\n            const prodValuesPath = path.join(prodFolder, 'values.yaml');\n            if (fs.existsSync(prodValuesPath)) {\n                const prodValContent = fs.readFileSync(prodValuesPath, 'utf8');\n                let values = yaml.load(prodValContent);\n\n                const isDbComp = role === 'db';\n\n                if (isDbComp) {\n                    // --- DB LOGIC: Use Lightweight Testing Chart ---\n                    const dbType = values.databaseType || 'mariadb';\n                    const dbRepo = values[dbType]?.image?.repository || (dbType === 'postgres' ? 'devopsnaratel/postgresql' : 'devopsnaratel/mariadb');\n                    const dbTag = values[dbType]?.image?.tag || (dbType === 'postgres' ? '18.1' : '12.1.2');\n                    const storageClass = values.storage?.className || 'longhorn';\n\n                    values = {\n                        namespace: `${appId}-db-${appName}-testing`,\n                        fullnameOverride: `sts-db-${appName}-${appId}`,\n                        databaseType: dbType,\n                        storage: { className: storageClass, size: \"2Gi\" },\n                        imagePullSecrets: [{ name: \"dockerhub-auth\" }],\n                        serviceAccount: { create: true, name: `sa-db-${appName}-test` },\n                        podAnnotations: {\n                            \"app.kubernetes.io/id\": appId,\n                            \"app.kubernetes.io/env\": \"testing\"\n                        }\n                    };\n\n                    if (dbType === 'mariadb') {\n                        values.mariadb = { image: { repository: dbRepo, tag: dbTag } };\n                    } else {\n                        values.postgres = { image: { repository: dbRepo, tag: dbTag } };\n                    }\n\n                } else {\n                    // --- APP LOGIC: Simple Clone & Metadata Update ---\n                    values.namespace = `${appId}-${appName}-testing`; \n                    values.app.env = 'testing';\n                    \n                    if (imageTag) values.image.tag = imageTag;\n\n                    // Ingress\n                    if (selectedDomain) {\n                        values.ingress = {\n                            enabled: true,\n                            className: \"nginx\",\n                            hosts: [{ host: selectedDomain, path: \"/\" }]\n                        };\n                    } else if (values.ingress && values.ingress.enabled && values.ingress.hosts) {\n                        values.ingress.hosts = values.ingress.hosts.map(h => ({\n                            ...h,\n                            host: `test-${h.host}`\n                        }));\n                    }\n                    \n                    // Migration\n                    // We use the same command as Prod (cloned from values), unless we want to force seed.\n                    // User requested to match WebUI input exactly.\n                    // if (values.migration && values.migration.enabled) {\n                    //    values.migration.command = \"php artisan migrate --seed --force\";\n                    // }\n                    \n                    // NO AGGRESSIVE OVERWRITE HERE\n                    // System expects that the Standby Secret ALREADY contains correct DB_HOST etc.\n                }\n\n                // Write Values\n                fs.writeFileSync(path.join(testFolder, 'values.yaml'), yaml.dump(values));\n                generatedFolders.push(`${appName}${suffixTest}`);\n            }\n        };\n\n        try {\n            // 3. Deploy App (Throws if no secret)\n            deployComponent('app', '-prod', '-testing');\n\n            // 4. Deploy DB (Throws if no secret)\n            if (dbType !== 'none') {\n                deployComponent('db', '-prod', '-testing');\n            }\n\n            if (generatedFolders.length === 0) {\n                 return NextResponse.json({ error: \"No manifests generated.\" }, { status: 400 });\n            }\n\n            // 5. Save Registry (Update assigned domain)\n            fs.writeFileSync(registryPath, JSON.stringify(registry, null, 2));\n\n            // 6. Commit & Push\n            execSync(`git add .`, { cwd: repoPath });\n            const commitMsg = `feat: deploy ephemeral testing for ${appName} using standby secrets`;\n            \n            try {\n                 execSync(`git commit -m \"${commitMsg}\"`, { cwd: repoPath });\n                 execSync(`git push origin main`, { cwd: repoPath });\n            } catch (e) {\n                 if (e.message.includes('nothing to commit')) {\n                     return NextResponse.json({ message: \"Environment already up-to-date.\" });\n                 }\n                 throw e;\n            }\n\n            return NextResponse.json({ \n                message: \"Ephemeral environment deployed successfully using standby secrets\", \n                folders: generatedFolders,\n                testDomain: selectedDomain,\n                namespaceApp: `${appId}-${appName}-testing`,\n                namespaceDb: dbType !== 'none' ? `${appId}-db-${appName}-testing` : null\n            });\n\n        } catch (err) {\n            // If deployComponent throws, it lands here\n            return NextResponse.json({ error: err.message }, { status: 400 });\n        }\n\n    });\n\n  } catch (err) {\n      console.error(err);\n      return NextResponse.json({ error: err.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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"}}]
}