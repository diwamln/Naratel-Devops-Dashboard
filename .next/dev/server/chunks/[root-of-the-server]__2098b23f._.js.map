{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/webui-devops/Naratel-Devops-Dashboard/src/lib/gitMutex.js"],"sourcesContent":["import { Mutex } from 'async-mutex';\n\n// Shared mutex instance to prevent race conditions during Git operations\nexport const gitMutex = new Mutex();\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,WAAW,IAAI,wMAAK"}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/webui-devops/Naratel-Devops-Dashboard/src/lib/jenkins.js"],"sourcesContent":["/**\n * Jenkins API Helper Library\n * Provides functions to manage Jenkins Pipeline jobs programmatically\n */\n\nconst JENKINS_URL = process.env.JENKINS_URL;\nconst JENKINS_USER = process.env.JENKINS_USER;\nconst JENKINS_API_TOKEN = process.env.JENKINS_API_TOKEN;\n\n/**\n * Get Base64 encoded auth header for Jenkins\n */\nfunction getAuthHeader() {\n    const credentials = Buffer.from(`${JENKINS_USER}:${JENKINS_API_TOKEN}`).toString('base64');\n    return `Basic ${credentials}`;\n}\n\n/**\n * Generate Jenkinsfile content from template\n * @param {Object} params - Pipeline parameters\n * @param {string} params.appName - Application name\n * @param {string} params.imageRepo - Docker image repository\n * @param {string} params.gitRepoUrl - Git repository URL for the app source code\n * @param {string} params.webuiUrl - WebUI API base URL\n */\nfunction generateJenkinsfile({ appName, imageRepo, gitRepoUrl, webuiUrl }) {\n    return `pipeline {\n    agent any\n\n    environment {\n        APP_NAME       = \"${appName}\"\n        DOCKER_IMAGE   = \"${imageRepo}\"\n        DOCKER_CRED_ID = \"docker-hub\"\n\n        // URL WebUI Base\n        WEBUI_API      = \"${webuiUrl}\"\n        \n        APP_VERSION    = \"\"\n    }\n\n    stages {\n        stage('Checkout & Get Version') {\n            steps {\n                script {\n                    checkout scm\n                    APP_VERSION = sh(\n                        script: \"git describe --tags --always --abbrev=0 || echo \\${BUILD_NUMBER}\",\n                        returnStdout: true\n                    ).trim()\n                    echo \"Building Version: \\${APP_VERSION}\"\n                }\n            }\n        }\n\n        stage('Build & Push Docker') {\n            steps {\n                script {\n                    docker.withRegistry('', \"\\${DOCKER_CRED_ID}\") {\n                        def customImage = docker.build(\"\\${DOCKER_IMAGE}:\\${APP_VERSION}\")\n                        customImage.push()\n                        customImage.push(\"latest\")\n                    }\n                }\n            }\n        }\n\n        stage('Deploy Testing (Ephemeral)') {\n            steps {\n                script {\n                    echo \"Triggering WebUI to create Ephemeral Testing Environment...\"\n                    def response = sh(script: \"\"\"\n                        curl -s -X POST \\${WEBUI_API}/api/jenkins/deploy-test \\\\\n                        -H \"Content-Type: application/json\" \\\\\n                        -d '{\"appName\": \"\\${APP_NAME}\", \"imageTag\": \"\\${APP_VERSION}\"}'\n                    \"\"\", returnStdout: true).trim()\n\n                    echo \"WebUI Response: \\${response}\"\n\n                    if (response.contains('\"error\"')) {\n                        error \"Failed to deploy testing env: \\${response}\"\n                    }\n\n                    echo \"Waiting for pods to be ready...\"\n                    sleep 60\n                }\n            }\n        }\n\n        stage('Integration Tests') {\n            steps {\n                script {\n                    echo \"Running Tests against Testing Env...\"\n                }\n            }\n        }\n\n        stage('Approval for Production') {\n            steps {\n                script {\n                    try {\n                        input message: \"Testing Done. Approve deploy \\${APP_VERSION} to Production?\",\n                              id: 'ApproveDeploy'\n                    } catch (Exception e) {\n                        currentBuild.result = 'ABORTED'\n                        error \"Deployment to Production Cancelled.\"\n                    }\n                }\n            }\n        }\n\n        stage('Deploy to Production') {\n            steps {\n                script {\n                    echo \"Updating Production Image Version...\"\n                    def response = sh(script: \"\"\"\n                        curl -s -X POST \\${WEBUI_API}/api/manifest/update-image \\\\\n                        -H \"Content-Type: application/json\" \\\\\n                        -d '{\"appName\": \"\\${APP_NAME}\", \"env\": \"prod\", \"imageTag\": \"\\${APP_VERSION}\"}'\n                    \"\"\", returnStdout: true).trim()\n\n                    echo \"WebUI Response: \\${response}\"\n\n                    if (response.contains('\"error\"')) {\n                        error \"Failed to update production: \\${response}\"\n                    }\n                }\n            }\n        }\n    }\n\n    post {\n        always {\n            script {\n                echo \"Cleaning up Ephemeral Testing Environment...\"\n                sh \"\"\"\n                    curl -s -X POST \\${WEBUI_API}/api/jenkins/destroy-test \\\\\n                    -H \"Content-Type: application/json\" \\\\\n                    -d '{\"appName\": \"\\${APP_NAME}\"}'\n                \"\"\"\n                cleanWs()\n            }\n        }\n    }\n}`;\n}\n\n/**\n * Generate Jenkins Pipeline Job XML config\n */\nfunction generateJobConfigXml({ appName, imageRepo, gitRepoUrl, webuiUrl }) {\n    const jenkinsfileContent = generateJenkinsfile({ appName, imageRepo, gitRepoUrl, webuiUrl });\n\n    // Escape XML special characters in Jenkinsfile\n    const escapedJenkinsfile = jenkinsfileContent\n        .replace(/&/g, '&amp;')\n        .replace(/</g, '&lt;')\n        .replace(/>/g, '&gt;')\n        .replace(/\"/g, '&quot;')\n        .replace(/'/g, '&apos;');\n\n    return `<?xml version='1.1' encoding='UTF-8'?>\n<flow-definition plugin=\"workflow-job\">\n  <description>CI/CD Pipeline for ${appName} - Auto-generated by Naratel DevOps Dashboard</description>\n  <keepDependencies>false</keepDependencies>\n  <properties>\n    <org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>\n      <triggers/>\n    </org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>\n  </properties>\n  <definition class=\"org.jenkinsci.plugins.workflow.cps.CpsScmFlowDefinition\" plugin=\"workflow-cps\">\n    <scm class=\"hudson.plugins.git.GitSCM\" plugin=\"git\">\n      <configVersion>2</configVersion>\n      <userRemoteConfigs>\n        <hudson.plugins.git.UserRemoteConfig>\n          <url>${gitRepoUrl}</url>\n          <credentialsId>git-token</credentialsId>\n        </hudson.plugins.git.UserRemoteConfig>\n      </userRemoteConfigs>\n      <branches>\n        <hudson.plugins.git.BranchSpec>\n          <name>*/main</name>\n        </hudson.plugins.git.BranchSpec>\n      </branches>\n      <doGenerateSubmoduleConfigurations>false</doGenerateSubmoduleConfigurations>\n      <submoduleCfg class=\"empty-list\"/>\n      <extensions/>\n    </scm>\n    <scriptPath>Jenkinsfile</scriptPath>\n    <lightweight>true</lightweight>\n  </definition>\n  <triggers/>\n  <disabled>false</disabled>\n</flow-definition>`;\n}\n\n/**\n * Check if a Jenkins job exists\n * @param {string} jobName - Name of the job to check\n * @returns {Promise<boolean>}\n */\nexport async function jobExists(jobName) {\n    if (!JENKINS_URL || !JENKINS_USER || !JENKINS_API_TOKEN) {\n        console.warn('[Jenkins] Missing configuration, skipping job check');\n        return false;\n    }\n\n    try {\n        const response = await fetch(`${JENKINS_URL}/job/${encodeURIComponent(jobName)}/api/json`, {\n            method: 'GET',\n            headers: {\n                'Authorization': getAuthHeader(),\n            },\n        });\n        return response.ok;\n    } catch (error) {\n        console.error('[Jenkins] Error checking job:', error.message);\n        return false;\n    }\n}\n\n/**\n * Create a new Jenkins Pipeline job\n * @param {Object} params - Job parameters\n * @param {string} params.appName - Application name (used as job name)\n * @param {string} params.imageRepo - Docker image repository\n * @param {string} params.gitRepoUrl - Git repository URL\n * @returns {Promise<{success: boolean, message: string}>}\n */\nexport async function createPipelineJob({ appName, imageRepo, gitRepoUrl }) {\n    if (!JENKINS_URL || !JENKINS_USER || !JENKINS_API_TOKEN) {\n        console.warn('[Jenkins] Missing configuration, skipping job creation');\n        return { success: false, message: 'Jenkins not configured' };\n    }\n\n    const jobName = appName;\n    const webuiUrl = process.env.NEXT_PUBLIC_APP_URL || process.env.NEXTAUTH_URL || 'http://localhost:3000';\n\n    // Check if job already exists\n    const exists = await jobExists(jobName);\n    if (exists) {\n        console.log(`[Jenkins] Job '${jobName}' already exists, skipping creation`);\n        return { success: true, message: `Job '${jobName}' already exists` };\n    }\n\n    const jobXml = generateJobConfigXml({ appName, imageRepo, gitRepoUrl, webuiUrl });\n\n    try {\n        // First, get crumb for CSRF protection\n        let crumb = null;\n        try {\n            const crumbResponse = await fetch(`${JENKINS_URL}/crumbIssuer/api/json`, {\n                method: 'GET',\n                headers: {\n                    'Authorization': getAuthHeader(),\n                },\n            });\n            if (crumbResponse.ok) {\n                const crumbData = await crumbResponse.json();\n                crumb = crumbData;\n            }\n        } catch (e) {\n            console.log('[Jenkins] Crumb issuer not available, proceeding without CSRF token');\n        }\n\n        // Create the job\n        const headers = {\n            'Authorization': getAuthHeader(),\n            'Content-Type': 'application/xml',\n        };\n\n        if (crumb) {\n            headers[crumb.crumbRequestField] = crumb.crumb;\n        }\n\n        const response = await fetch(`${JENKINS_URL}/createItem?name=${encodeURIComponent(jobName)}`, {\n            method: 'POST',\n            headers,\n            body: jobXml,\n        });\n\n        if (response.ok) {\n            console.log(`[Jenkins] Successfully created job '${jobName}'`);\n            return { success: true, message: `Jenkins job '${jobName}' created successfully` };\n        } else {\n            const errorText = await response.text();\n            console.error(`[Jenkins] Failed to create job: ${response.status}`, errorText);\n            return { success: false, message: `Failed to create Jenkins job: ${response.status}` };\n        }\n    } catch (error) {\n        console.error('[Jenkins] Error creating job:', error.message);\n        return { success: false, message: `Jenkins error: ${error.message}` };\n    }\n}\n\n/**\n * Delete a Jenkins job\n * @param {string} jobName - Name of the job to delete\n * @returns {Promise<{success: boolean, message: string}>}\n */\nexport async function deleteJob(jobName) {\n    if (!JENKINS_URL || !JENKINS_USER || !JENKINS_API_TOKEN) {\n        console.warn('[Jenkins] Missing configuration, skipping job deletion');\n        return { success: false, message: 'Jenkins not configured' };\n    }\n\n    // Check if job exists\n    const exists = await jobExists(jobName);\n    if (!exists) {\n        console.log(`[Jenkins] Job '${jobName}' does not exist, skipping deletion`);\n        return { success: true, message: `Job '${jobName}' does not exist` };\n    }\n\n    try {\n        // Get crumb for CSRF protection\n        let crumb = null;\n        try {\n            const crumbResponse = await fetch(`${JENKINS_URL}/crumbIssuer/api/json`, {\n                method: 'GET',\n                headers: {\n                    'Authorization': getAuthHeader(),\n                },\n            });\n            if (crumbResponse.ok) {\n                const crumbData = await crumbResponse.json();\n                crumb = crumbData;\n            }\n        } catch (e) {\n            console.log('[Jenkins] Crumb issuer not available');\n        }\n\n        const headers = {\n            'Authorization': getAuthHeader(),\n        };\n\n        if (crumb) {\n            headers[crumb.crumbRequestField] = crumb.crumb;\n        }\n\n        const response = await fetch(`${JENKINS_URL}/job/${encodeURIComponent(jobName)}/doDelete`, {\n            method: 'POST',\n            headers,\n        });\n\n        if (response.ok || response.status === 302) {\n            console.log(`[Jenkins] Successfully deleted job '${jobName}'`);\n            return { success: true, message: `Jenkins job '${jobName}' deleted successfully` };\n        } else {\n            const errorText = await response.text();\n            console.error(`[Jenkins] Failed to delete job: ${response.status}`, errorText);\n            return { success: false, message: `Failed to delete Jenkins job: ${response.status}` };\n        }\n    } catch (error) {\n        console.error('[Jenkins] Error deleting job:', error.message);\n        return { success: false, message: `Jenkins error: ${error.message}` };\n    }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 438, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/webui-devops/Naratel-Devops-Dashboard/src/app/api/manifest/delete/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { execSync } from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\nimport os from 'os';\nimport { gitMutex } from '@/lib/gitMutex';\nimport { deleteJob } from '@/lib/jenkins';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function POST(req) {\n    const { appId, appName } = await req.json();\n\n    if (!appId || !appName) {\n        return NextResponse.json({ error: \"Missing appId or appName\" }, { status: 400 });\n    }\n\n    return await gitMutex.runExclusive(async () => {\n        const repoDirName = 'manifest-repo-workdir';\n        const repoPath = path.join(os.tmpdir(), repoDirName);\n        const registryPath = path.join(repoPath, 'registry.json');\n        const appsPath = path.join(repoPath, 'apps');\n\n        const token = process.env.GITHUB_TOKEN;\n        const repoUrl = process.env.MANIFEST_REPO_URL;\n        const userName = process.env.GIT_USER_NAME || \"Naratel DevOps Dashboard\";\n        const userEmail = process.env.GIT_USER_EMAIL || \"devops@naratel.com\";\n\n        if (!repoUrl || !token) {\n            return NextResponse.json({ error: \"Configuration Error: MANIFEST_REPO_URL or GITHUB_TOKEN is missing.\" }, { status: 500 });\n        }\n\n        try {\n            // --- 1. Git Setup (Clone/Pull) ---\n            const authenticatedUrl = repoUrl.replace(\"https://\", `https://${token}@`);\n\n            if (!fs.existsSync(repoPath)) {\n                execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n                execSync(`git config user.name \"${userName}\"`, { cwd: repoPath });\n                execSync(`git config user.email \"${userEmail}\"`, { cwd: repoPath });\n            } else {\n                try {\n                    execSync(`git fetch origin`, { cwd: repoPath });\n                    execSync(`git reset --hard origin/main`, { cwd: repoPath });\n                } catch (e) {\n                    // Re-clone if corrupt\n                    fs.rmSync(repoPath, { recursive: true, force: true });\n                    execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n                    execSync(`git config user.name \"${userName}\"`, { cwd: repoPath });\n                    execSync(`git config user.email \"${userEmail}\"`, { cwd: repoPath });\n                }\n            }\n\n            // --- 2. Remove Folders ---\n            // We look for folders starting with appName inside 'apps/'\n            // Expected patterns: {appName}-prod, {appName}-testing, {appName}-db-prod, {appName}-db-testing\n\n            const foldersToDelete = [];\n            if (fs.existsSync(appsPath)) {\n                const files = fs.readdirSync(appsPath);\n                files.forEach(file => {\n                    // Strict check to ensure we don't delete \"inventory-backend\" when deleting \"inventory\"\n                    // The folders generated are exactly: appName + \"-prod\", \"-testing\", \"-db-prod\", \"-db-testing\"\n                    if (file === `${appName}-prod` ||\n                        file === `${appName}-testing` ||\n                        file === `${appName}-db-prod` ||\n                        file === `${appName}-db-testing`) {\n\n                        const fullPath = path.join(appsPath, file);\n                        fs.rmSync(fullPath, { recursive: true, force: true });\n                        foldersToDelete.push(file);\n                    }\n                });\n            }\n\n            // --- 3. Update Registry ---\n            let registry = [];\n            if (fs.existsSync(registryPath)) {\n                try {\n                    registry = JSON.parse(fs.readFileSync(registryPath, 'utf8'));\n                } catch (e) {\n                    console.error(\"Failed to parse registry\", e);\n                }\n            }\n\n            const initialLength = registry.length;\n            registry = registry.filter(app => app.id !== appId);\n\n            if (foldersToDelete.length === 0 && registry.length === initialLength) {\n                return NextResponse.json({ message: \"App not found or already deleted.\" });\n            }\n\n            fs.writeFileSync(registryPath, JSON.stringify(registry, null, 2));\n\n            // --- 4. Commit & Push ---\n            const commitMsg = `chore: delete application ${appName} (ID: ${appId})`;\n\n            execSync(`git add .`, { cwd: repoPath });\n            try {\n                // Check if there are changes to commit\n                const status = execSync(`git status --porcelain`, { cwd: repoPath }).toString();\n                if (status.trim()) {\n                    execSync(`git commit -m \"${commitMsg}\"`, { cwd: repoPath });\n                    execSync(`git push origin main`, { cwd: repoPath });\n                } else {\n                    return NextResponse.json({ message: \"No changes to commit (already clean).\" });\n                }\n            } catch (e) {\n                throw new Error(\"Git push failed: \" + e.message);\n            }\n\n            // --- 5. Delete Jenkins Job ---\n            let jenkinsMessage = '';\n            try {\n                const jenkinsResult = await deleteJob(appName);\n                if (jenkinsResult.success) {\n                    jenkinsMessage = ` | ${jenkinsResult.message}`;\n                    console.log(`[Jenkins] ${jenkinsResult.message}`);\n                } else {\n                    jenkinsMessage = ` | Jenkins: ${jenkinsResult.message}`;\n                    console.warn(`[Jenkins] ${jenkinsResult.message}`);\n                }\n            } catch (jenkinsErr) {\n                console.error('[Jenkins] Failed to delete pipeline:', jenkinsErr.message);\n                jenkinsMessage = ' | Jenkins job deletion failed (non-blocking)';\n            }\n\n            return NextResponse.json({\n                message: `Successfully deleted ${appName}${jenkinsMessage}`,\n                deletedFolders: foldersToDelete\n            });\n\n        } catch (err) {\n            console.error(err);\n            return NextResponse.json({ error: err.message }, { status: 500 });\n        }\n    });\n}\n"],"names":[],"mappings":"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"}}]
}