{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/webui-devops/Naratel-Devops-Dashboard/src/lib/gitMutex.js"],"sourcesContent":["import { Mutex } from 'async-mutex';\n\n// Shared mutex instance to prevent race conditions during Git operations\nexport const gitMutex = new Mutex();\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,WAAW,IAAI,wMAAK"}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/webui-devops/Naratel-Devops-Dashboard/src/app/api/manifest/next-id/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { execSync } from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\nimport os from 'os';\nimport yaml from 'js-yaml';\nimport { gitMutex } from '@/lib/gitMutex';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET() {\n  return await gitMutex.runExclusive(async () => {\n      const repoDirName = 'manifest-repo-workdir';\n      const repoPath = path.join(os.tmpdir(), repoDirName);\n      const registryPath = path.join(repoPath, 'registry.json');\n      \n      const token = process.env.GITHUB_TOKEN;\n      const repoUrl = process.env.MANIFEST_REPO_URL;\n      \n      // Default jika repo belum ada\n      if (!repoUrl || !token) {\n        return NextResponse.json({ nextId: \"001\" });\n      }\n\n      try {\n        // 1. Setup Git (Clone/Pull) untuk memastikan data terbaru\n        const authenticatedUrl = repoUrl.replace(\"https://\", `https://${token}@`);\n\n        if (!fs.existsSync(repoPath)) {\n            execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n        } else {\n            try {\n              execSync(`git fetch origin`, { cwd: repoPath });\n              execSync(`git reset --hard origin/main`, { cwd: repoPath });\n            } catch (e) {\n              // Re-clone jika corrupt\n              fs.rmSync(repoPath, { recursive: true, force: true });\n              execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n            }\n        }\n\n        // 2. Baca registry.json\n        let registry = [];\n        if (fs.existsSync(registryPath)) {\n            const content = fs.readFileSync(registryPath, 'utf8');\n            registry = JSON.parse(content);\n        }\n\n        // 3. Enrich Registry with Real Ingress Data\n        const enrichedRegistry = registry.map(app => {\n            const prodValuesPath = path.join(repoPath, 'apps', `${app.name}-prod`, 'values.yaml');\n            const testValuesPath = path.join(repoPath, 'apps', `${app.name}-testing`, 'values.yaml');\n            \n            let prodHost = null;\n            let testHost = null;\n\n            // Read Prod\n            if (fs.existsSync(prodValuesPath)) {\n                try {\n                    const doc = yaml.load(fs.readFileSync(prodValuesPath, 'utf8'));\n                    if (doc.ingress && doc.ingress.enabled && doc.ingress.hosts && doc.ingress.hosts.length > 0) {\n                        prodHost = doc.ingress.hosts[0].host;\n                    }\n                } catch (e) { console.warn(`Failed to read prod values for ${app.name}`, e); }\n            }\n\n            // Read Testing\n            if (fs.existsSync(testValuesPath)) {\n                try {\n                    const doc = yaml.load(fs.readFileSync(testValuesPath, 'utf8'));\n                    if (doc.ingress && doc.ingress.enabled && doc.ingress.hosts && doc.ingress.hosts.length > 0) {\n                        testHost = doc.ingress.hosts[0].host;\n                    }\n                } catch (e) { console.warn(`Failed to read test values for ${app.name}`, e); }\n            }\n\n            return {\n                ...app,\n                liveIngressProd: prodHost,\n                liveIngressTest: testHost\n            };\n        });\n\n        // 4. Cari ID Maksimal\n        let maxId = 0;\n        enrichedRegistry.forEach(app => {\n            const idNum = parseInt(app.id);\n            if (!isNaN(idNum) && idNum > maxId) {\n                maxId = idNum;\n            }\n        });\n\n        const nextId = String(maxId + 1).padStart(3, '0');\n        return NextResponse.json({ nextId, registry: enrichedRegistry });\n\n      } catch (error) {\n        console.error(\"Error in next-id:\", error);\n        // Fallback jika gagal\n        return NextResponse.json({ nextId: \"001\", error: error.message });\n      }\n  });\n}"],"names":[],"mappings":"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"}}]
}