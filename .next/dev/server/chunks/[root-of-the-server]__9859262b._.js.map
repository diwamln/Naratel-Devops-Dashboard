{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/webui-devops/Naratel-Devops-Dashboard/src/lib/gitMutex.js"],"sourcesContent":["import { Mutex } from 'async-mutex';\n\n// Shared mutex instance to prevent race conditions during Git operations\nexport const gitMutex = new Mutex();\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,WAAW,IAAI,wMAAK"}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/webui-devops/Naratel-Devops-Dashboard/src/app/api/manifest/update-image/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { execSync } from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\nimport os from 'os';\nimport yaml from 'js-yaml';\nimport { gitMutex } from '@/lib/gitMutex';\n\nexport async function POST(req) {\n  try {\n    const data = await req.json();\n    const { appName, env, imageTag } = data; // env: 'prod' or 'testing'\n\n    if (!appName || !env || !imageTag) {\n        return NextResponse.json({ error: \"appName, env, and imageTag are required\" }, { status: 400 });\n    }\n\n    const repoDirName = 'manifest-repo-workdir';\n    const repoPath = path.join(os.tmpdir(), repoDirName);\n    \n    const token = process.env.GITHUB_TOKEN;\n    const repoUrl = process.env.MANIFEST_REPO_URL;\n    const userName = process.env.GIT_USER_NAME || \"Naratel DevOps Dashboard\";\n    const userEmail = process.env.GIT_USER_EMAIL || \"devops@naratel.com\";\n\n    if (!repoUrl || !token) {\n        return NextResponse.json({ error: \"Configuration Error\" }, { status: 500 });\n    }\n\n    return await gitMutex.runExclusive(async () => {\n        // 1. Git Setup\n        const authenticatedUrl = repoUrl.replace(\"https://\", `https://${token}@`);\n        if (!fs.existsSync(repoPath)) {\n            execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n            execSync(`git config user.name \"${userName}\"`, { cwd: repoPath });\n            execSync(`git config user.email \"${userEmail}\"`, { cwd: repoPath });\n        } else {\n            execSync(`git fetch origin`, { cwd: repoPath });\n            execSync(`git reset --hard origin/main`, { cwd: repoPath });\n        }\n\n        const targetFolder = path.join(repoPath, 'apps', `${appName}-${env}`);\n        const valuesPath = path.join(targetFolder, 'values.yaml');\n\n        if (!fs.existsSync(valuesPath)) {\n             return NextResponse.json({ error: `Manifest folder for ${appName}-${env} not found.` }, { status: 404 });\n        }\n\n        // 2. Read & Update Yaml\n        const fileContent = fs.readFileSync(valuesPath, 'utf8');\n        let values = yaml.load(fileContent);\n\n        // Update Tag\n        if (values.image) {\n            values.image.tag = imageTag;\n        } else {\n             return NextResponse.json({ error: \"Invalid values.yaml structure: missing image key\" }, { status: 400 });\n        }\n\n        // Write Back\n        fs.writeFileSync(valuesPath, yaml.dump(values));\n\n        // 3. Commit & Push\n        execSync(`git add .`, { cwd: repoPath });\n        const commitMsg = `ci: update ${appName}-${env} to version ${imageTag}`;\n        \n        try {\n             execSync(`git commit -m \"${commitMsg}\"`, { cwd: repoPath });\n             execSync(`git push origin main`, { cwd: repoPath });\n        } catch (e) {\n             if (e.message.includes('nothing to commit')) {\n                 return NextResponse.json({ message: \"Version already up-to-date.\" });\n             }\n             throw e;\n        }\n\n        return NextResponse.json({ message: `Successfully updated ${appName}-${env} to tag ${imageTag}` });\n    });\n\n  } catch (err) {\n      console.error(err);\n      return NextResponse.json({ error: err.message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}