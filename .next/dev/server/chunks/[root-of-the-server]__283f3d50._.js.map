{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/rahan/Magang/cicd/Naratel-Devops-Dashboard/src/app/api/jenkins/pending/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\n\nexport async function GET() {\n  const { JENKINS_URL, JENKINS_USER, JENKINS_API_TOKEN } = process.env;\n\n  if (!JENKINS_URL || !JENKINS_USER || !JENKINS_API_TOKEN) {\n    return NextResponse.json(\n      { error: 'Konfigurasi Jenkins tidak lengkap di ENV' },\n      { status: 500 }\n    );\n  }\n\n  const auth = Buffer.from(`${JENKINS_USER}:${JENKINS_API_TOKEN}`).toString('base64');\n\n  try {\n    // 1. Fetch daftar semua jobs dari Jenkins (Optimized dengan tree)\n    // Kita hanya mengambil job yang sedang building/running untuk mengurangi request ke API\n    const jobsResponse = await fetch(`${JENKINS_URL}/api/json?tree=jobs[name,url,color,lastBuild[building]]`, {\n      headers: { 'Authorization': `Basic ${auth}` },\n      cache: 'no-store'\n    });\n\n    if (!jobsResponse.ok) {\n      throw new Error(`Gagal fetch daftar jobs: ${jobsResponse.statusText}`);\n    }\n\n    const jenkinsData = await jobsResponse.json();\n    const allJobs = jenkinsData.jobs || [];\n\n    if (allJobs.length === 0) {\n      return NextResponse.json({ message: 'Tidak ada job ditemukan di Jenkins' });\n    }\n\n    // 2. Filter hanya job yang sedang aktif (Running/Building)\n    const activeJobs = allJobs.filter(job => {\n      // Cek apakah lastBuild sedang building atau color punya animasi (indikator running)\n      const isBuilding = job.lastBuild?.building === true;\n      const isAnime = job.color?.toString().endsWith('_anime');\n      return isBuilding || isAnime;\n    });\n\n    // Extract nama job dari active jobs\n    const jobNames = activeJobs.map(job => job.name);\n\n    console.log(`Optimization: Processing ${jobNames.length} active jobs out of ${allJobs.length} total jobs.`);\n    \n    if (jobNames.length === 0) {\n      return NextResponse.json({\n        totalJobs: allJobs.length,\n        activeJobs: 0,\n        pendingBuilds: 0,\n        data: []\n      });\n    }\n\n    // 3. Fetch data dari ACTIVE job secara Paralel (Promise.all)\n    const promises = jobNames.map(async (jobName) => {\n      try {\n        const res = await fetch(`${JENKINS_URL}/job/${jobName}/wfapi/runs`, {\n          headers: { 'Authorization': `Basic ${auth}` },\n          cache: 'no-store'\n        });\n\n        if (!res.ok) {\n          console.log(`Job ${jobName}: HTTP ${res.status}`);\n          return [];\n        }\n\n        const runs = await res.json();\n        console.log(`Job ${jobName}: ${runs.length} runs ditemukan`);\n\n        // Filter & Map data\n        const pending = runs\n          .filter((run) => {\n            console.log(`  - Run ${run.id}: status = ${run.status}`);\n            return run.status === 'PAUSED_PENDING_INPUT';\n          })\n          .map((run) => ({\n            id: run.id,\n            name: run.name,\n            status: run.status,\n            timestamp: run.startTimeMillis,\n            jobName: jobName\n          }));\n\n        if (pending.length > 0) {\n          console.log(`Job ${jobName}: ${pending.length} pending approval ditemukan!`);\n        }\n\n        return pending;\n      } catch (err) {\n        console.error(`Gagal fetch job ${jobName}:`, err.message);\n        return [];\n      }\n    });\n\n    // Tunggu semua request selesai\n    const results = await Promise.all(promises);\n\n    // 4. Gabungkan array of arrays menjadi satu array flat (single list)\n    const allPendingBuilds = results.flat();\n\n    // Urutkan berdasarkan waktu (terbaru diatas)\n    allPendingBuilds.sort((a, b) => b.timestamp - a.timestamp);\n\n    console.log('Total pending builds:', allPendingBuilds.length);\n\n    return NextResponse.json({\n      totalJobs: allJobs.length,\n      activeJobs: jobNames.length,\n      pendingBuilds: allPendingBuilds.length,\n      data: allPendingBuilds\n    });\n\n  } catch (error) {\n    console.error('Error utama:', error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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"}}]
}